<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>JOSBoxModule.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="ee8236e8592001eb8afbeaaf95fc4965" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="image/wikiHome.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="UsersWebHome.html">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="MainWebHome.html">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="InfoWebHome.html">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="DevZoneWebHome.html">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="SupportWebHome.html">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<! page="">JOSBoxModule</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="ImportedWebHome.html">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=ee8236e8592001eb8afbeaaf95fc4965" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<! page=""><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <! page="">info</a> on or <a href="WebHome.html">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<! page="">login</a> or <! page="">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="Glossary.html">topics</a>, <! page="">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="NewArticles2a.html">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="PlatformAPIPages.html">PlatformAPIPages</a></FONT>
<HR SIZE="1" NOSHADOW>
<EM>Article contributed by <a href="GilbertHerschberger.html">GilbertHerschberger</a> (19 November 1999).</EM>
<H4>Introduction</H4>
<P>A module might be part of the JOSBox environment.</P>
<P>Note: A native module plugs into a kernel, not a JOSBox. Therefore, it is more correct to think of modules as a <a href="JOSKernelModule.html">JOSKernelModule</a>. -- <a href="GilbertHerschberger.html">GilbertHerschberger</a> (6 December 1999).</P>
<H4>Non-JOS JVM</H4>
<P>A classic <! page="">JVM</a> benefits from the native operating system. A native operating system already has a mechanism for shared (or dynamic link) libraries. Native code is dynamically linked into a <! page="">JVM</a> with the <CODE>loadLibrary()</CODE> method.</P>
<P>Note: A significant change in the Java 2 Platform encourages a dynamic link library to be managed by a class loader, rather than a JVM.</P>
<H4>JOS JVM</H4>
<P>A JOS <! page="">JVM</a> does not have another native operating system. It doesn't inherent any mechanism for shared libraries. How does the <! page="">JVM</a> load and dynamically link in any native code? The mechanism of dynamic linking requires three things:</P>
<UL>
<LI><P><STRONG>well-known executable image format</STRONG></P>
<P>In order for an executable image to be loaded and invoked correctly, it must put its code and data in the right place. JOS has yet to define an executable image format for native subroutines.</P>
<LI><P><STRONG>subrouting (or method) index</STRONG></P>
<P>Each method must have a name and an entry point. The typical shared library mechanism assumes that a return exists in the code to return to the calling code. The <! page="">CPU</a> calls the code starting at the entry point. The entry point is the first op code of native subroutine.</P>
<LI><P><STRONG>reflection</STRONG></P>
<P>Each public subroutine in a shared library must export its name and entry point. There are more assumptions about parameter passing, such as how many and what type of parameter is passed. The shared library mechanism uses a very low level <EM>reflection</EM>. The signature of each subroutine is verified at compile-time, not run-time.</P>
</UL>
<P>Reflection provides a calling program a look-up mechanism. By using a well-positioned reflection subroutine, the names of all public subroutines can be determined dynamically and the entry point for each routine can be determined.</P>
<P>As this mechanism matured, the operating system loads an executable image and calls its init() method before using any other library method. As the operating system unloads an executable image, it calls its exit() method.</P>
<P>These mechanisms have been formalized in Java bytecode, with classes and other well-defined interfaces. And yet, the JOS kernel needs to load shared libraries without using another operating system. How is this done?</P>
<H4>Use Linux format</H4>
<P>One way to <EM>instantly</EM> get shared libraries in JOS is to borrow heavily from the Linux shared library format. A Linux-compatible compiler might be used to compile the native code that goes into a JOS module. The Linux-compatible linker might be used to link native code into an executable image file.</P>
<P>A linker tool must be able to create the share library. A linker is responsible for putting the executable image on disk so that the kernel has no trouble loading it at runtime.</P>
<P>While something like the Linux file format should be used, the executable code inside won't match the Linux platform API. A Linux compiler might be able to create these shared libraries; but, they are incompatible. They cannot be invoked on Linux.</P>
<H4>Use class-file format</H4>
<P>At least in theory, it is possible to pre-compile native methods using the class-file format, without a separate shared library. Unlike native methods that store a signature and no native code, native code can be stored in the attribute field of a bytecode method. Bytecode classes with inseparable native code is appealing. Both the bytecode and native code are stored together in a .class file.</P>
<P>It would require a special kind of linker to create a class-file from native compiled object files. Such an attribute would be ignored by other virtual machines.</P>
<H4>Configuration</H4>
<P>The JOS kernel configuration determines which modules get loaded (and when). Like kernel modules for Linux, a JOSBox module is a kernel plug-in. It determines what a JOS machine is capable of doing.</P>
<P>A network module might be required, for example, to use a network card in hardware. Selecting a network module must be part of kernel configuration. For a JOS machine without network support, the network module is never loaded.</P>
<P>A serial-port module might be required, for example, to use a serial port in hardware. Selecting a serial port module must be part of kernel configuration. For a JOS machine without a serial port, the serial port module is never loaded.</P>
<P>A <! page="">JVM</a> module might be required, for example, to use additional instances of a virtual machine for Java 0 and 1 Platform support. Selecting a <! page="">JVM</a> module is part of kernel configuration. For a <! page="">JOS</a> machine that uses only one JVM, the <! page="">JVM</a> is compiled into the kernel; no additional <! page="">JVM</a> module is necessary.</P>
<H4>Where used</H4>
<P>JOSBox modules are used wherever shared libraries would be used in a classic JVM. Like shared libraries, a <! page="">JVM</a> is able to use the module to invoke native code.</P>
<P>Unlike shared libraries, modules are not unloaded at the end of a program. Since the <! page="">JVM</a> is the only "program", modules are unloaded when the operating system is shutdown.</P>
<H4>Discovery</H4>
<P>All of the public (exported) subroutines in a shared library are numbered from 0 to n. The entry point into each subroutine is inside an array of entry points. The subroutine number is an index into that array.</P>
<P>The first group of subroutine in a shared library are required to have the same signature in every shared library. It is as if a shared library implements this a <CODE>SharedLibrary</CODE> interface:</P>
<PRE>
public interface SharedLibrary {
  public void init();
  public void exit();
  public int getSubroutineCount();
  public byte[] getEntryPointArray();
  public String[] getNameArray();
}
</PRE>
<P>After reading an executable image from disk, the image must be prepared for invocation as native code. Parts of the executable image are installed as READ-ONLY-CODE, parts are READ-ONLY-DATA, parts are READ-WRITE-DATA.</P>
<P>Then, the shared library loader must invoke a shared library's init() method. This gives a shared library an opportunity to do housekeeping and load other shared libraries. The shared library loader invokes the init() method using something like this:</P>
<PRE>
// using the C language
void (*init)();

void invokeInit( void *exported ) {
  init = exported;
  init();
}
</PRE>
<P>In order to invoke the exit() method, native code must perform something like this:
<PRE>
// using the C language
void (*exit)();

void invokeExit( void *exported ) {
  exit = exported[ 1 ];
  exit();
}
</PRE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<! page="">login</a> or <! page="">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

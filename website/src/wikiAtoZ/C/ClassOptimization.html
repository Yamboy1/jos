<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>ClassOptimization.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="203a93229ed7ec425c1003001e7b251b" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//ClassOptimization?PHPSESSID=203a93229ed7ec425c1003001e7b251b">ClassOptimization</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=203a93229ed7ec425c1003001e7b251b" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=203a93229ed7ec425c1003001e7b251b"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/ClassOptimization?PHPSESSID=203a93229ed7ec425c1003001e7b251b">info</a> on or <a href="/edit/Imported/ClassOptimization?PHPSESSID=203a93229ed7ec425c1003001e7b251b">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FClassOptimization&PHPSESSID=203a93229ed7ec425c1003001e7b251b">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FClassOptimization&PHPSESSID=203a93229ed7ec425c1003001e7b251b">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=203a93229ed7ec425c1003001e7b251b">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=BytecodePages&PHPSESSID=203a93229ed7ec425c1003001e7b251b">BytecodePages</a><wikitopic BytecodePages /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=203a93229ed7ec425c1003001e7b251b">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (9 May 2000).</EM></P>
<H4>Introduction</H4>
<P>An object is always linked to a class. A class is linked to other classes.</P>
<H4>Object</H4>
<P>When an object is linked to a class, one object is really linked to another. Here is the example we'll use to illustrate class optimization. It is a simple example.</P>
<PRE>
public class MyApp {
  public static void main( String[] args ) {
  }
}
</PRE>
<P>This example only creates objects that are part of a virtual machine, plus the <CODE>MyApp</CODE> class itself.</P>
<OL>
<LI><P>A virtual machine uses the equivalent of this to load my application's class.</P>
<PRE>
  public void example() {
	 Class.forName( "MyApp" );
  }
</PRE>
<P>The <CODE>java.lang.Class</CODE> class must be loaded and enough of it resolved to invoke the <CODE>forName()</CODE> method. Since an instance of <CODE>java.lang.String</CODE> is passed to the <CODE>forName()</CODE> method, it must be loaded and resolved.  Depending on the implementation of <CODE>java.lang.String</CODE>, many other classes may be loaded and resolved. The <CODE>forName()</CODE> method create an instance of <CODE>java.lang.Class</CODE>.</P>
<LI><P><CODE>java.lang.Class</CODE> extends <CODE>java.lang.Object</CODE>. The <CODE>java.lang.Object</CODE> class itself is loaded. It is given a new object reference number. It remains unresolved.</P>
<LI><P>The size of an object is vm-specific. The size of a class object is vm-specific. The object and class object have place holders for object references to class and class loader, respectively.</P>
<LI><P>The <CODE>MyApp</CODE> class is not the first object created. It might be given a new object reference number. At this point, the <CODE>MyApp</CODE> class is unresolved.</P>
<LI><P><CODE>MyApp</CODE> is an instance of <CODE>java.lang.Class</CODE>. The <CODE>java.lang.Class</CODE> class itself is loaded. It is the second object created. It is given a new object reference number. It remains unresolved.</P>
<LI><P>The <CODE>main()</CODE> method passes an array of <CODE>java.lang.String</CODE>. An array class must be loaded and resolved. The <CODE>java.lang.String</CODE> class has already been resolved.</P>
<LI><P>Behind the scenes, the <CODE>java.lang.Runtime</CODE> class must be loaded and resolved. The <CODE>java.lang.System</CODE> class must be loaded and resolved, too. With the resolution of <CODE>java.lang.System</CODE>, the <CODE>java.io.InputStream</CODE> and <CODE>java.io.OutputStream</CODE> classes must be loaded and resolved.</P>
<LI><P>Further behind the scenes, an instance of <CODE>java.lang.Thread</CODE> has already been started for the user interface, garbage collector, finalizer and main thread. A thread and its related classes must be loaded and resolved.</P>
</OL>
<P>Class resolution (and optimization) is recursive. When a class needs to be resolved, a virtual machine methodically traverses each new class and does whatever is necessary. The exception mechanism provides a clean way to escape the recursion on the first error and pass an appropriate message to a calling method.</P>
<H4>Superclass</H4>
<P>A superclass must be resolved as needed. <CODE>java.lang.Object</CODE> is the superclass of <CODE>java.lang.Class</CODE>. The superclass field of <CODE>java.lang.Class</CODE> is initialized to null. It is eventually updated with a direct link to <CODE>java.lang.Object</CODE>. Once the superclass for <CODE>java.lang.Class</CODE> is resolved, it can be used repeatedly without additional overhead.</P>
<PRE>
  public void resolveSuperclass() {
	 if ( superClass == null ) {
		superClass = lookupClass( getSuperClassName() );
	 }
  }
</PRE>
<H4>This class</H4>
<P>The <CODE>getClass()</CODE> method of <CODE>java.lang.Object</CODE> returns an instance of <CODE>java.lang.Class</CODE>. The internal representation of an object includes a placeholder for the object's class. A native method might be useful to return the object reference for an object's class.</P>
<PRE>
  public native Class getClass();
</PRE>
<H4>No instance</H4>
<P><CODE>MyApp</CODE> extends <CODE>java.lang.Object</CODE>; but an instance of <CODE>MyApp</CODE> is never created in the example program. A highly optimized implementation might not resolve the superclass of <CODE>MyApp</CODE>, even with the potential for static fields. If <CODE>MyApp</CODE> extended <CODE>AbstractApp</CODE> and it has never been referenced, <CODE>MyApp</CODE> might run even though <CODE>AbstractApp</CODE> does not exist.</P>
<H4>Method</H4>
<P>When the <CODE>main()</CODE> method is invoked, a virtual machine must resolve each class, resolve the <CODE>main()</CODE> method and then interpret each instruction in the <CODE>main()</CODE> method. No matter how many instances of a class are created, a method is resolved only once. The hidden <CODE>this</CODE> parameter is always passed to an instance method. <CODE>this</CODE> is an object reference to the internal representation of an object.</P>
<H4>Pointers</H4>
<P>Pointers are far more efficient than making copies of everything. An object reference is duplicated throughout the object graph, especially for the many references to system classes. An object must contain the monitor and vm-specific support for garbage collection.</P>
<P>When using the <CODE>synchronized</CODE> keyword, an object can be reserved for exclusive use of a single thread. A synchronized instance method uses the <CODE>this</CODE> parameter to manage an object's monitor. The synchronized keyword uses the same monitor on an object.</P>
<PRE>
  public void example( Object v ) {
	 synchronized( v ) {
	 }
  }
</PRE>
<P>A class is an object, too. A class object can be reserved for exclusive use of a single thread. A synchronized static method uses the monitor of a class object. The synchronized keyword uses the same monitor on a class object.</P>
<PRE>
  public void example( Class v ) {
	 synchronized( v ) {
	 }
  }
</PRE>
<H4>Throws</H4>
<P>When a Code attribute of a method contains a <CODE>throws</CODE> table, each class in the table can be loaded and resolved as needed.</P>
<H4>Parameters</H4>
<P>Parameters need to be resolved. When non-primatives are passed to a method, a class must be loaded and resolved as needed. Resolution is needed when a method is invoked.</P>
<H4>Methods</H4>
<P>When class A invokes method X of class B, class A can store a direct link to class B and method X. The parameters to method X are verified by class A once and only once, even when dealing with a superclass. Class B cannot be changed. Methods of class B cannot be changed.</P>
<PRE>
  invokevirtual java/lang/Object.toString(V)V
</PRE>
<P>Class A might save a direct link to the <CODE>java.lang.Object</CODE> class. It might save a link to its <CODE>toString(V)V</CODE> method. The next time this bytecode is invoked, the thread does not have to use the <CODE>getMethodCodeAttribute()</CODE> method of Class B.</P>
<P>Each method can be assigned a simple 32-bit method ID. The <CODE>getMethodIDByDefinition()</CODE> method returns the method ID of the <CODE>toString(V)V</CODE> method. Then the method ID is passed to <CODE>getMethodAttribute()</CODE> to obtain the bytecode for the method. An <CODE>invokeMethod()</CODE> method takes a method definition or method ID as a parameter.</P>
<H4>Too much optimization</H4>
<P>When a virtual machine doesn't work at all, there may be too much optimization. Saving the pointer to a class requires more RAM. Saving the pointer to fields and methods require even more RAM. Optimizing for speed is important for some applications.</P>
<P>On the other hand, a virtual machine can be optimized for space. Instead of saving the pointer to other fields and methods, it might be enough to use a fixed-size cache of pointers to other classes, in a most-recently-used scheme. If the superclass hasn't been used for a while, the class cache can discard the direct reference. A superclass can always be looked up multiple times when optimizing for size.</P>
<P>When optimized for size, a class might look up a field sequentially, starting with field 1. It might not sort the field list. It might not create a field manager at all. The field ID is an index into a field table. The field table for an instance is part of the <CODE>this</CODE> object. The field table for a class is part of the <CODE>getClass()</CODE> object. Static fields are known by their static attribute. All other fields are instance fields.</P>
<P>When optimized for size, a class might look up a method sequentially, starting with method 1. It might not sort the method list. It might not create a method manager at all.</P>
<P>Once a class has been compiled, its method list cannot be changed. The method ID is a reliable way to identify methods internally in a virtual machine. Static methods are known by their static attribute. All other methods are instance methods, with a hidden <CODE>this</CODE> parameter.</P>
<H4>Exceptions</H4>
<P>Exceptions in the standard class library are loaded and resolved as needed. If an instance of <CODE>ArrayIndexOutOfBoundsException</CODE> class is never created, its class is never loaded, never resolved.</P>
<H4>Summary</H4>
<P>With these and other well-known facts about bytecode, a virtual machine can be optimized for speed or size. When optimized for speed, everything that can be looked up once should be looked up once. When optimized for size, no space is wasted on a reference that can be looked up by calling a method.</P><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FClassOptimization&PHPSESSID=203a93229ed7ec425c1003001e7b251b">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FClassOptimization&PHPSESSID=203a93229ed7ec425c1003001e7b251b">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

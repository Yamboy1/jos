<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>NativeExecMethod.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="e23ac2cb3a750d4e68c333b57bf016a9" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//NativeExecMethod?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">NativeExecMethod</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/NativeExecMethod?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">info</a> on or <a href="/edit/Imported/NativeExecMethod?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FNativeExecMethod&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FNativeExecMethod&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ProcessPages&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">ProcessPages</a><wikitopic ProcessPages /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (10 April 2000).</EM></P>
<H4>Introduction</H4>
<P>The <CODE>exec()</CODE> method is part of the <CODE>java.lang.Runtime</CODE> class. The <CODE>exec()</CODE> method creates a child process. A child process in <nolink>JOS is a bytecode process. It is not a machine code process, like those found in other operating systems.</P>
<P>Inside a virtual machine, here is the standard signature of the <CODE>exec()</CODE> method:</P>
<PRE>
exec([Ljava/lang/String;[Ljava/lang/String)Ljava/lang/Process
</PRE>
<P>In the Java programming language, all four signatures of these <CODE>exec()</CODE> methods are compatible with the classic design:</P>
<UL>
&lt;LI&gt;<PRE>public Process exec(String[], String[]) {
:
}</PRE>
&lt;LI&gt;<PRE>public synchronized Process exec(String[], String[]) {
:
}</PRE>
<LI><PRE>public native Process exec(String[], String[]);</PRE>
<LI><PRE>public native synchronized Process exec(String[], String[]);</PRE>
</UL>
<H4>Type</H4>
<P>The persistence barrier prevents us from having the same type associated with two different class loaders. An instance of class loader is part of an object's type.</P>
<P>When run, the following method might print "different type":</P>
<PRE>
  public void example() {
	 String cn = "MyClass";

	 ClassLoader xLoader = new CustomClassLoader();
	 ClassLoader yLoader = new CustomClassLoader();

	 Class x = xLoader.loadClass( cn );
	 Class y = yLoader.loadClass( cn );

	 if ( isType( x, y ) ) {
		println( "same type" );
	 }
	 else {
		println( "different type" );
	 }
  }
  public boolean isType( Class x, Class y ) {
	 if ( !x.getName().equals( y.getName() ) ) {
		return false;
	 }

	 if ( x.getClassLoader() == null &amp;&amp;
		  y.getClassLoader() == null ) {
		return true;
	 }

	 return ( x.getClassLoader() == x.getClassLoader() );
  }
</PRE>
<P>How do we cross the persistence barrier?</P>
<P>Unlike most machine code structures, a virtual machine could copy any object from one process to another because it "knows" the memory layout of every object. The <CODE>CloneObject()</CODE> method might be implemented in machine code.</P>
<P>Other than a call to the native <CODE>CloneObject()</CODE> method, the <CODE>exec()</CODE> method might be bytecode and nothing but bytecode. On the other hand, the <CODE>exec()</CODE> method can be implemented as a native method to reuse existing archives, rt.jar and classes.zip.</P>
<H4>Sequence</H4>
<P>Here is the story of a parent process invoking a child process.</P>
<OL>
<LI><P>The parent process creates a command.</P>
<P>A command is passed to the <CODE>exec()</CODE> method. The parent process uses its own custom class loader to create an instance of <CODE>java.lang.String</CODE>. This string is incompatible with the child process.</P>
<LI><P>The parent process invokes the <CODE>exec()</CODE> method.</P>
<P>For this scenario, the <CODE>exec()</CODE> method is implemented in machine code. It is native. It uses some kind of <a href="/view.php?topic=NativeInterface&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">NativeInterface</a><wikitopic NativeInterface /wikitopic>.</P>
<LI><P>The <CODE>exec()</CODE> method must create a new custom class loader, a new thread, and a new instance of the command.</P>
<LI><P>The <CODE>exec()</CODE> method returns an instance of <CODE>java.lang.Process</CODE> or <CODE>null</CODE>.</P>
<P>The instance of <CODE>java.lang.Process</CODE> returned to the parent process must be created with the custom class loader of the parent process.</P>
</OL>
<H4>Converting a string</H4>
<P>The original command is stored in a string. The string is created by the custom class loader of a parent process. The custom class loader of a parent process is a not the same as a parent class loader. An instance of <CODE>java.lang.String</CODE> is passed to the <CODE>exec()</CODE> method.</P>
<P>The machine code of the <CODE>ClassLoader::CloneString()</CODE> method must do something like this:</P>
<PRE>
jstring CloneString( java_lang::ClassLoader loader, jstring v ) {
  const char *buf = new char[ v.length() ];

  // Make a machine code copy of the given string.
  strncpy( buf, v.getData(), v.length() );

  jclass stringClass =
	  loader-&gt;loadClass( "java.lang.String" );

  // Create a bytecode copy of the given string.
  return = stringClass-&gt;newString( buffer );
}
</PRE>
<P>The multiple process virtual machine must provide corresponding methods for copying any object from one process to another.</P>
<PRE>
/**
 * Duplicate an object for a new class loader.
 * @param loader a custom class loader
 * @param v any old object
 */
public native Object CloneObject( ClassLoader loader, Object v );
</PRE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FNativeExecMethod&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FNativeExecMethod&PHPSESSID=e23ac2cb3a750d4e68c333b57bf016a9">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

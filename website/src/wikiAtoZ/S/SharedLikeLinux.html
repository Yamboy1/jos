<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>SharedLikeLinux.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="d13a41539a4fe071eca4936303175550" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=d13a41539a4fe071eca4936303175550">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=d13a41539a4fe071eca4936303175550">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=d13a41539a4fe071eca4936303175550">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=d13a41539a4fe071eca4936303175550">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=d13a41539a4fe071eca4936303175550">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//SharedLikeLinux?PHPSESSID=d13a41539a4fe071eca4936303175550">SharedLikeLinux</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=d13a41539a4fe071eca4936303175550">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=d13a41539a4fe071eca4936303175550" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=d13a41539a4fe071eca4936303175550"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/SharedLikeLinux?PHPSESSID=d13a41539a4fe071eca4936303175550">info</a> on or <a href="/edit/Imported/SharedLikeLinux?PHPSESSID=d13a41539a4fe071eca4936303175550">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FSharedLikeLinux&PHPSESSID=d13a41539a4fe071eca4936303175550">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FSharedLikeLinux&PHPSESSID=d13a41539a4fe071eca4936303175550">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=d13a41539a4fe071eca4936303175550">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=d13a41539a4fe071eca4936303175550">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=d13a41539a4fe071eca4936303175550">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ProcessPages&PHPSESSID=d13a41539a4fe071eca4936303175550">ProcessPages</a><wikitopic ProcessPages /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=d13a41539a4fe071eca4936303175550">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (28 April 2000).</EM></P>
<H4>Introduction</H4>
<P>By extending what we already know about shared libraries in machine code, we can learn more about shared libraries in bytecode. A class definition is a shared library in bytecode. Like a shared library in machine code, class definitions are special. All duplicate class definitions can be eliminated. All virtual machines could benefit from a vm-wide or system-wide class definition cache.</P>
<P>The shared library <nolink>API on Linux and Windows are essencially the same. The <nolink>Zerich subproject shows that a shared library can be abstracted, implemented in C++ as a platform-independent framework.</P>
<H4>Dynamic cast</H4>
<P>When class definitions are equal, an object can be dynamically cast from one process to another. When class definitions are equal, an object can be moved from one process to another. Both class definitions must be intern'd in order for them to be equal. A class definition that has never been intern'd cannot be shared.</P>
<P>If intern'ing is optional, it might be helpful to flag a class definition as intern'd or not. A class definition that has never been interned cannot be shared. It can never be equal to any other class definition. It is owned exclusively by exactly one process.</P>
<H4>About Linux</H4>
<P>There are two kinds of shared libraries on Linux: system and application. A system shared library is found through the library path and library configuration. For optimization, the <CODE>ldconfig</CODE> program updates the in-memory list of libraries on the library path.</P>
<P>A shared library does not have to be installed. A shared library can be stored anywhere, not just on the library path. An application library, like <CODE>libjavai.so</CODE>, can be stored inside an application directory. It is loaded as part of an application.</P>
<H4>Only one</H4>
<P>When a shared library is loaded, it is always intern'd by the Linux kernel. The Linux kernel only loads a shared library once to save limited resources of both real and virtual memory.</P>
<P>A shared library is a shared library regardless of where it is stored. The Linux kernel intern's all shared libraries. Both system and application shared libraries are intern'd.</P>
<P>The mechanism is the same. A shared library stays loaded while any process keeps it open. A shared library may be unloaded if no process has it open.</P>
<H4>Handle</H4>
<P>A process always gets a handle to a shared library. The kernel always owns the shared library. When asked to load a shared library, the kernel returns a handle, not a shared library. The kernel keeps a lot of information about the shared library in the kernel. The kernel knows how many processes have opened the shared library. The kernel knows which processes have opened the shared library.</P>
<P>The kernel uses a simple reference count to keep track of usage. When a shared library is opened, an open count is incremented. When it is closed, an open count is decremented.</P>
<P>A process can open a shared library more than once. If a process opens a shared library more than once the kernel returns the same handle each time; but, an open count property is incremented each time the library is opened.</P>
<P>When a process is killed (or a process opens a shared library without closing it), the kernel does the right thing. It <EM>automatically</EM> disconnects the process from all of its open shared libraries. A process and its shared libraries are disposed of properly.</P>
<P>By providing a handle to a shared library -- and only a handle -- to a process, ownership is unmistakeable. A kernel always owns a shared library.</P>
<UL>
<LI><P>The kernel encapsulates the information required to load and track shared libraries. All operations on a shared library must be performed using a valid handle, owned by a process.</P>
<P>The shared library <nolink>API is well-known and stable. The shared library interface does not need to change from one build of the kernel to the next.</P>
<LI>It makes it easy to clean up after a process. The semantics and side-effects of shared libraries are well-known and easy to understand. There are no surprises. There are no work arounds required because the basic design is appropriate to the task.</P>
</UL>
<H4>Shared object</H4>
<P>A shared library is a shared object. It is a machine code-based object. Like an object in a virtual machine, a shared library has a handle or object reference. The scope of a handle is the same as the scope of an object reference. The process cannot make use of a handle directly, but only through the shared library <nolink>API.</P>
<P>Size is the most significant difference between a shared library on Linux and an Object in Java. While a Linux application may have a handful of large shared libraries, an equivalent Java application may have a large quantity of small objects. While shared libraries tend to be large, Java objects tend to be small.</P>
<P>While machine code is assumed in Linux shared libraries, bytecode is assumed in Java objects. These are platform defaults. And yet, a Linux shared library can contain bytecode, such as a bytecode resource. A Java class can contain machine code, such as a <nolink>JVM-specific attribute.</P>
<H4>Static <nolink>MPCL-compatible design</H4>
<P>An MPCL-compatible virtual machine with bytecode resources can be statically linked with a kernel. One executable image contains a kernel, a virtual machine and boot packages.</P>
<P>A virtual machine must convert a boot class into an instance of <CODE>java.lang.Class</CODE>.</P>
<OL>
<LI><P>At runtime, the bytecode resource <nolink>API is used by a virtual machine to find a class definition. This <nolink>API is implemented in machine code and linked into a virtual machine.</P>
<LI><P>A virtual machine implements <CODE>java.lang.ClassLoader</CODE>, which is a <nolink>JVM-specific class. This class is a hybrid class, part machine code and part bytecode.</P>
<LI><P>The native implementation of <CODE>ClassLoader.defineClass()</CODE> can intern a class definition. A class definition is implemented in machine code. When intern'd, all potentially duplicate class definitions are eliminated.</P>
</OL>
<P>Intern'ing the class definition does two very important things. First and foremost, it enables a dynamic cast of an object from one bytecode process to another. The check is simple. If two classes have the same intern'd class definition, an object can be cast from one bytecode process to another (and so on).</P>
<P>Second, both real and virtual memory is optimized by eliminating duplicate class definitions. The virtual machine must track class definitions like Linux tracks shared libraries. Since a class <EM>is-a</EM> shared library, it should be no surprise that two kinds of shared libraries should be tracked in a similar way.</P>
<TABLE BORDER="1" CELLPADDING="8" BGCOLOR="#EFEFEF">
<TR>
<TD>
<P><EM>Sidebar: Optimizing other virtual machines</EM></P>
<P>There are other virtual machines, both commercial and non-commercial. Many of these other virtual machines have been optimized for a classic design, inefficient and wasteful of real and virtual memory of a foreign operating system. Some of these have been reworked, but not yet fully optimized for <nolink>JNI design, which enables multiple Java processes within a single native process. These virtual machines are available now without the automatic intern'ing of class definitions.</P>
<P>Both a classic design and <nolink>JNI design can be improved. Every virtual machine can be optimized by virtual vm-wide class definition cache, <EM>and should be</EM>.</P>
</TD>
</TR>
</TABLE>
<H4>About <nolink>Win32</H4>
<P>Shared libraries on <nolink>Win32 (32-bit versions of Microsoft Windows) are similar to shared libraries on Linux. Shared libraries are called dynamic link libraries to emphasize how they are linked at runtime, or dynamically.</P>
<P>As with Linux, there are two kinds of shared libraries on <nolink>Win32: system and application. A system shared library can be loaded through a system-wide executable program path (PATH), a sequential list of directories. For optimization, a shared library can be loaded from the Windows directory (typically C:WINDOWS) or the Windows System directory (typically C:WINDOWSSYSTEM).</P>
<P>As with Linux, a shared library does not have to be installed. A shared library can be stored anywhere, not just on PATH. An application library, like <CODE>javai.dll</CODE>, can be stored inside an application directory. It is loaded as part of an application.</P><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FSharedLikeLinux&PHPSESSID=d13a41539a4fe071eca4936303175550">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FSharedLikeLinux&PHPSESSID=d13a41539a4fe071eca4936303175550">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

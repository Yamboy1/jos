<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>SystemClassFinder.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="18fccd8165b49d1072b7e27f1b023216" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//SystemClassFinder?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">SystemClassFinder</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=18fccd8165b49d1072b7e27f1b023216" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=18fccd8165b49d1072b7e27f1b023216"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/SystemClassFinder?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">info</a> on or <a href="/edit/Imported/SystemClassFinder?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FSystemClassFinder&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FSystemClassFinder&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=18fccd8165b49d1072b7e27f1b023216">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ProcessPages&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">ProcessPages</a><wikitopic ProcessPages /wikitopic>; <a href="/view.php?topic=PrimordialClassLoader&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">PrimordialClassLoader</a><wikitopic PrimordialClassLoader /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (13 April 2000).</EM></P>
<H4>Introduction</H4>
<P>A virtual machine must find a system class. This article presents a system class finder and a primordial class loader as two separate components.</P>
<UL>
<LI><P>A virtual machine <EM>uses</EM> a primordial class loader. In a classic design, a virtual machine has only one. In a multiple primordial class loader (MPCL) design, a virtual machine can have more than one.</P>
<LI><P>A primordial class loader <EM>uses</EM> a system class finder. A primordial class loader and a system class finder are two separate components, <EM>and should be</EM>.</P>
</UL>
<H4>Loading a class</H4>
<P>Arbitrary classes can be loaded dynamically. The <CODE>forName()</CODE> method is part of the <CODE>java.lang.Class</CODE> method. It accepts a class name as a parameter. It returns an instance of <CODE>java.lang.Class</CODE> (or throws an exception).</P>
<PRE>
  public void example() {
	 String[] list =
		  "java.lang.ArrayIndexOutOfBoundsException",
		  "java.lang.Class",
		  "java.lang.ClassLoader",
		  "java.lang.Error",
		  "java.lang.Object",
		  "java.lang.Runtime",
		  "java.lang.System",
		  "java.lang.Thread",
		  "java.lang.ThreadGroup",
		  "java.lang.VirtualMachineError"
		  };

	 int iMax = list.length;
	 for ( int i = 0; i &lt; iMax; i++ ) {
		try {
		  Class c = Class.forName( list[ i ] );
		  println( c.getName() );
		}
		catch( Throwable e ) {
		  _print( e );
		}
	 }
  }
</PRE>
<P>The <CODE>forName()</CODE> method looks up a class in a class cache. If possible, it will return an existing class. Otherwise, it <EM>uses</EM> a class loader.</P>
<PRE>
  public void example() {
	 String cn = "java.lang.Runtime";

	 Class c1;
	 try {
		c1 = Class.forName( cn );
	 }
	 catch( Throwable e ) {
		_print( e );
		return;
	 }

	 int iMax = 100000;
	 for ( int i = 0; i &lt; iMax; i++ ) {
		try {
		  Class c2 = Class.forName( cn );
		}
		catch( Throwable e ) {
		  _print( e );
		  break;
		}

		if ( c1 != c2 ) {
		  println( "[" + i + "] c1 != c2" );
		  break;
		}
	 }
  }
</PRE>
<H4>Class loader</H4>
<P>Like all class loaders, a primordial class loader turns a <EM>class file</EM> into an instance of <CODE>java.lang.Class</CODE>. A <EM>class file</EM> is a binary data. It is bytecode. In the Java programming language, it is often represented as a byte array. A primordial class loader invokes a <CODE>defineClass()</CODE> method.</P>
<P><EM>But where does the byte array come from?</EM></P>
<P>A primordial class loader depends on other components. It depends on a bytecode provider. A bytecode provider, not a primordial class loader, actually reads a class file into a byte array.</P>
<P>Therefore, it is always a two-step process.</P>
<OL>
<LI><P><STRONG>Load a class file into a byte array.</STRONG></P>
<P>The class file is loaded into a byte array by a class file provider, or rather, a bytecode provider.</P>
<LI><STRONG>Use the byte array to define a class.</STRONG>
<P>Machine code and bytecode methods can define a class. During initialization, a virtual machine can define a class. In the <a href="/view.php?topic=JNI&web=Imported&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">JNI</a> <wikitopic JNI /wikitopic>design, any machine code method can define a class. By extending java.lang.ClassLoader, a bytecode method can define a class. The <CODE>defineClass()</CODE> method in bytecode delegates to a corresponding <CODE>defineClass()</CODE> method in machine code.</P>
</OL>
<P>The <CODE>defineClass()</CODE> method in machine code may throw an exception for a variety of reasons. A malformed class file cannot be converted into an instance of java.lang.Class. A class cannot be defined twice for one class loader. The <CODE>defineClass()</CODE> method in machine code requires two parameters: a class loader and byte array.</P>
<PRE>
void vm::defineClass( java_lang::ClassLoader *loader, const char *v );
</PRE>
<H4>Bytecode provider</H4>
<P>A bytecode provider accepts a class specification and, if possible, returns a byte array. A class specification always uses a forward slash as a separator, instead of a dot. A primordial class loader convert a class name to a class specification and passes the class specification to a bytecode provider.</P>
<PRE>
public interface BytecodeProvider {
  public abstract byte[] getClassFile( String v );
}
</PRE>
<H4>Variety</H4>
<P>There are a wide variety of bytecode providers. A bytecode provider can load a bytecode from many different sources.
<UL>
<LI>a bytecode resource,
<LI>a directory,
<LI>an archive,
<LI>an <a href="/view.php?topic=HTTP&web=Imported&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">HTTP</a> <wikitopic HTTP /wikitopic>service,
<LI>an <a href="/view.php?topic=FTP&web=Imported&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">FTP</a> <wikitopic FTP /wikitopic>service,
<LI>an <a href="/view.php?topic=SQL&web=Imported&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">SQL</a> <wikitopic SQL /wikitopic>service,
<LI>a <a href="/view.php?topic=TFTP&web=Imported&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">TFTP</a> <wikitopic TFTP /wikitopic>service,
<LI>and many more.
</UL>
<P>Each source of bytecode must have a corresponding bytecode provider. While a new bytecode provider is required, a new class loader is not.</P>
<H4>As a resource</H4>
<P>A <a href="/view.php?topic=BytecodeResource&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">BytecodeResource</a><wikitopic BytecodeResource /wikitopic> is linked to an executable image. A bytecode resource loads bytecode through the same mechanism used to load machine code.</P>
<UL>
<LI><P>A statically linked bytecode resource puts bytecode in the same executable image with a virtual machine. Both the machine code and bytecode can be statically linked together in a single executable image. All of the statically linked bytecode is read-only and managed seemlessly by a virtual memory manager.</P>
<LI><P>A dynamically linked bytecode resource loads bytecode through the same mechanism used for machine code. Bytecode is compiled into a dynamic shared library. A virtual machine must explicitly load a shared library to find its bytecode.</P>
</UL>
<P>Bytecode can be stored in <a href="/view.php?topic=ROM&web=Imported&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">ROM</a> <wikitopic ROM /wikitopic>using the same mechanism for storing machine code. Bytecode can be isolated from a virtual machine and stored in separate ROM. A virtual machine and its bytecode can be stored together on the same ROM. When a virtual machine and its boot packages are statically linked, the executable image may be ROM-able.</P>
<P>A bytecode resource must have a corresponding bytecode provider. A bytecode provider must return a byte array when given a class specification. When bytecode is stored as a resource, the corresponding provider returns a pointer to the start of a read-only byte array. There is no need to make additional copies of the bytecode resource.</P>
<H4>System classes</H4>
<P>System classes can be defined by a virtual machine as it is initialized. Definition and resolution are separate steps, <EM>and should be</EM>. When a primordial class loader uses a bytecode provider, it does not know how or where the bytecode is stored.</P>
<P>In the following example, a virtual machine can use the machine code methods of a primordial class loader to define system classes. Note that the class loader property of a system class is always null in a classic design.</P>
<PRE>
void vm::defineCriticalSystemClasses() {
  const char *list[] = {
	 "java/lang/Object",
	 "java/lang/Class",
	 "java/lang/ClassLoader",
	 "java/lang/System",
	 "java/lang/Runtime",
	 "java/lang/Thread",
	 "java/lang/ThreadGroup",
	 ""
	 };

  const unsigned char *cf;

  for ( int i = 0; ; i++ ) {
	 if ( *list[ i ] == '</PRE>
<BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FSystemClassFinder&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FSystemClassFinder&PHPSESSID=18fccd8165b49d1072b7e27f1b023216">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

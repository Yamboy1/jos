<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>StartupSequence.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="0df98c7c0732003de32a260d37f2e051" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//StartupSequence?PHPSESSID=0df98c7c0732003de32a260d37f2e051">StartupSequence</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=0df98c7c0732003de32a260d37f2e051" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=0df98c7c0732003de32a260d37f2e051"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/StartupSequence?PHPSESSID=0df98c7c0732003de32a260d37f2e051">info</a> on or <a href="/edit/Imported/StartupSequence?PHPSESSID=0df98c7c0732003de32a260d37f2e051">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FStartupSequence&PHPSESSID=0df98c7c0732003de32a260d37f2e051">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FStartupSequence&PHPSESSID=0df98c7c0732003de32a260d37f2e051">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=0df98c7c0732003de32a260d37f2e051">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=0df98c7c0732003de32a260d37f2e051">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic>.</EM>
<H4>Introduction</H4>
<P>JOS needs a good startup sequence. The startup sequence determines which part of the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>must be written in native code and what can be written in Java bytecode. Whatever can be written in bytecode should be written in bytecode.</P>
<P>For more information on the startup sequence, see also <a href="/view.php?topic=RegistryDesign&PHPSESSID=0df98c7c0732003de32a260d37f2e051">RegistryDesign</a><wikitopic RegistryDesign /wikitopic> and <a href="/view.php?topic=StartupSequencePart2&PHPSESSID=0df98c7c0732003de32a260d37f2e051">StartupSequencePart2</a><wikitopic StartupSequencePart2 /wikitopic>.</P>
<H4>Loading Java classes</H4>
<P>Many Java classes must be loaded when the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>itself is loaded. I have been working on a few alternatives.</P>
<OL>
<LI><STRONG>Many files</STRONG> We could put the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>in one file and bytecode in .class files, just like the original Java virtual machine. This assumes a working OS file subsystem, which we don't have. For each package, this assumes one directory, which we don't have. At the beginning of the startup sequence, native code has very primative access to a local drive. Putting bytecode in .class files is not feasible.
<LI><STRONG>Two files</STRONG> We could put <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>in one file. And then, we could put all boot packages into another file, like a single .jar file. The <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>would read the .jar to find the bytecode for all boot classes. While this is better and more feasible than alternative 1, it isn't as stable as it could be. One version of the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>could accidentally load classes from another version.
<LI><STRONG>One file</STRONG> We could put the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>and all boot packages into a single file. When the startup sequence loads the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>image into RAM, all of the boot classes are loaded into RAM, too. This option makes the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>and its boot packages inseparable. They are forever bound together at compile-time. This makes the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>very stable and self-contained.
</UL>
<H4>JOS class loader</H4>
<P>JOS <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>needs a primordial class loader. This class loader is part of the JVM. It is written in native C/C++. Plus, the <CODE>jos.jvm.PrimordialClassLoader</CODE> class is an interface to this native C/C++ code. With a <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>loaded from one file, the primordial class loader must be able to find bytecode stored in <a href="/view.php?topic=RAM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">RAM</a> <wikitopic RAM /wikitopic>past the end of the native code.</P>
<H4>About <CODE>java.*</CODE></H4>
<P>Are some of the standard Java packages also boot packages? For maximum flexibility, boot packages could depend on classes in these standard Java packages.
<UL>
<LI><CODE>java.lang</CODE>,
<LI><CODE>java.io</CODE>,
<LI><CODE>java.net</CODE>, and
<LI><CODE>java.util.zip</CODE>.
</UL>
<H4>One image</H4>
<P>When the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>is linked into an executable image, all of the standard Java packages should be statically linked to it, too. By putting the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>and its dependencies into a single executable image, they become inseparable. It is hard to install one file incorrectly. One version of a <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>cannot load boot packages from another version.</P>
<H4>Sequence</H4>
<P>Bytecode must be loaded before any Java object exists. Bytecode must be loaded before any Class object exists, because <CODE>java.lang.Class</CODE> depends on <CODE>java.lang.Object</CODE>. So how does <CODE>java.lang.Object</CODE> exist without an instance of <CODE>java.lang.Object</CODE>?</P>
<P>Inside the JVM, the primative mechanism to create and destroy "objects" doesn't know anything about <CODE>java.lang.Object</CODE>. A primative "object" is created and associated with a <CODE>java.lang.Object</CODE>. Since the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>"knows" how big a <CODE>java.lang.Object</CODE> object will be, it can create a placeholder for it. If each Object takes 10 bytes, the primative mechanism allocates 10 bytes. Resolving an object takes place later.</P>
<H4>Inseparable</H4>
<P>If the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>image contains native code and bytecode in a single file, the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>doesn't need any OS file subsystem or device driver to load all of the boot classes.</P>
<P>At the beginning of the startup sequence, the contiguous <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>image is loaded into RAM. The native <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>loader must "know" the number of bytes to read and where to start.</P>
<P>Once the primary <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>JVM is loaded into RAM, all of the operations to turn bytecode into classes are performed inside RAM. There are no more seeks to disk.</P>
<H4>Linker</H4>
<P>Boot packages are linked to the native code. All boot packages are packaged in uncompressed package files and concatinated to the native <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>code. The primary <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>JVM image looks like this on disk and in RAM.
<TABLE WIDTH="100%" CELLPADDING="5" BORDER="1" BGCOLOR="#EFEFEF">
<TR>
<TD ALIGN="CENTER">
<STRONG>jvm</STRONG>
<TABLE WIDTH="100%" CELLPADDING="5" BORDER="1" BGCOLOR="#FFCC66">
<TR>
<TD ALIGN="CENTER">
<STRONG>native code</STRONG>
</TD>
</TR>
</TABLE>
<TABLE WIDTH="100%" CELLPADDING="5" BORDER="1" BGCOLOR="#FFFFCC">
<TR>
<TD ALIGN="CENTER">
<STRONG>boot packages</STRONG><BR>
<PRE>java.io
java.lang
java.net
java.util.zip
jos.jvm</PRE>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE>
<H4>Loading one image</H4>
<P>Loading one executable image at boot time is much easier than trying figure out the sequence for native drivers vs. Java drivers. Since all of the boot packages are loaded when the computer is restarted, they are guaranteed to be available.</P>
<P>The native code required to load a contiguous file into <a href="/view.php?topic=RAM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">RAM</a> <wikitopic RAM /wikitopic>is very simple. It loads the whole file into RAM. It reads one sector after another, contiguously, until all of the bytes of the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>are loaded.</P>
<H4>After <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>is loaded</H4>
<P>After the primary <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>JVM has been loaded, it converts bytecode to classes. A <CODE>PrimordialClassLoader</CODE> could be written in such a way that classes are converted from bytecode to classes as they are requested through <CODE>ClassLoader.findSystemClass()</CODE>.</P>
<P>This design provides maximum flexibility because the programmer compiling the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>decides at compile time what packages are needed in order to boot the JVM. Once a <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>is compiled, it is installed as the primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>in the usual way. Once a <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>is loaded at startup, it is impossible to change anything inside this set of these packages. They are fixed and stable at compile/link time.</P>
<P>The standard Java <nolink>API requires an implementation of the <CODE>java.lang.Process</CODE> and <CODE>java.lang.Runtime</CODE> classes. A primary <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>JVM should implement these classes to load and run secondary JVMs. This corresponds to the secondary domains of a distributed architecture. It enables a <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>programmer to run <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>1.x on a machine while developing <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JOS</a> <wikitopic JOS /wikitopic>2.x.</P>
<P>The primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>manages all system-wide drivers. It manages drivers for the system-wide registry, OS file subsystem, OS network subsystem. Since the primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>supplies the system-wide drivers, secondary JVMs are free to have some other architecture. The one-file <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>is only required by the primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>in order to push through the startup sequence.</P>
<H4>Variety</H4>
<P>This architecture makes it possible to have a variety of different primary JVMs, with different designs. While one primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>uses uncompressed package files (optimized for speed), another may use compressed package files (optimized for space).</P>
<P>This architecture makes it possible for a variety of boot packages. While one primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>uses <CODE>java.io</CODE> exclusively, another may use <CODE>java.net</CODE>.</P>
<P>In addition, the primary JVM, with its boot packages, could be written in such a way to download additional drivers. If <CODE>java.net</CODE> is a boot package, additional drivers could be downloaded across a network.</P>
<P>This architecture enables support for different drivers and different driver mechanisms to be compiled into the primary JVM. In order to add support for brand new device driver architecture, you may need to link and install a new primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>and reboot your computer.</P>
<H4>Upgrading the primary JVM</H4>
<P>One <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>file is installed as the primary JVM. It must be stored at the front of a drive in order to use it at startup. Upgrading the primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>is two parts: link and install. Upon link, boot packages are concatinated to the native code. Upon install, the one <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>file is copied to a special place at the beginning of a drive. The file must be stored contiguously. Otherwise, install must fail.</P>
<H4>Next</H4>
<P>Once the primary <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=0df98c7c0732003de32a260d37f2e051">JVM</a> <wikitopic JVM /wikitopic>has been loaded and configured, it passes control to a shell. While it may run inside the primary JVM, a shell uses <CODE>java.lang.Process</CODE> and <CODE>java.lang.Runtime</CODE> to launch secondary JVMs at the request of the end-user.</P><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FStartupSequence&PHPSESSID=0df98c7c0732003de32a260d37f2e051">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FStartupSequence&PHPSESSID=0df98c7c0732003de32a260d37f2e051">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

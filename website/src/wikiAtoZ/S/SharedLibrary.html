<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>SharedLibrary.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="e4a335c86bd241e22b4b1080d3dc6c88" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//SharedLibrary?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">SharedLibrary</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/SharedLibrary?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">info</a> on or <a href="/edit/Imported/SharedLibrary?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FSharedLibrary&PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FSharedLibrary&PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ArchitectureGroup&PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">ArchitectureGroup</a><wikitopic ArchitectureGroup /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (28 February 2000).</EM></P>
<H4>Introduction</H4>
<P>Reusable bytecode and machine code goes into a shared library. This article explains shared libraries in C++ and Java, on Linux and Windows.</P>
<H4>Common code</H4>
<P>After building a few dozen applications, you are likely to find that applications are about 80% the same and 20% different. There is a lot of commonality between applications. Part of the commonality comes from our desire to have <EM>consistent behavior</EM> across all applications. Consistent behavior means that two or more applications perform a function in the same (or similar) manner.</P>
<H4>Static linking</H4>
<P>It is not recommended to link all your code statically into an executable program. A static link copies methods (subroutines) into the excutable image. Such a program would be very large.</P>
<P>Maintaining programs would become a nightmare. A change to any subsystem would require you to relink all programs everywhere.</P>
<H4>Invoking a subprogram</H4>
<P>An application can be reduced in complexity if common functionality is delegated to separate programs. A parent program uses exec() or spawn() to invoke a child program. The child program is supposed to contain common functionality.</P>
<P>This is the most popular mechanism. Look at the number of programs found in a typical installation of Linux. Most of the features of "Linux" are implemented in small and independent child programs.</P>
<P>The traditional model limits the interaction between a parent and child. It is intentional for each program, child and parent, to run in a separate kernel process. The parent and child are independent and isolated from each other. It is difficult, although not impossible, to pass complex data from parent to child. The interface between parent and child is either a classic command line (with its string-based arguments) or a binary I/O stream (or pipe).</P>
<H4>Invoking a shared library</H4>
<P>A shared library is a special kind of child program. The difference between a normal child program and shared library is the interface between the parent and child.</P>
<P>A shared library opens up a new interaction between parent and child. It is easier to pass complex data from parent to child. The interface between parent and child is the normal processor stack. The parent invokes methods of the child. A child offers many entry points into the child program.</P>
<H4>In C++</H4>
<P>A class in C++ might be implemented in a shared library. What is required for a parent to use a shared class?</P>
<UL>
<LI><P><STRONG>Common declaration</STRONG></P>
<P>The composition (memory layout) of a class in C++ is determined at compile-time. The size of a class depends on a class declaration. Typically, a common declaration is written a header file (.h, .hpp). The header file is used by both a shared library and all the applications that share it.</P>
<P>It is critical to the success of a shared library to understand the affect of changes. If an application is compiled before a header file is changed, the class expected by an application won't match the class implemented in a shared library.</P>
<LI><P><STRONG>Class implementation</STRONG></P>
<P>A class implementation library should be compiled according to the additional requirements of a shared library. A compiler must produce slightly different code when common code is shared among processes.</P>
<LI><P><STRONG>Pure virtual class</STRONG></P>
<P>Because of the complications of keeping a shared class library synchonized with header files and other applications, use pure virtual classes to expose functionality. Pure virtual classes should have no size at all. All of the fields of pure virtual class should be implemented in a private extension of the class.</P>
<LI><P><STRONG>Factory</STRONG></P>
<P>When you implement a class in a shared library, it is a very good idea to provide a C-style object factory. A factory creates an instance of your class. A factory loosens the coupling between the application and shared library.</P>
</UL>
<H4>In Java</H4>
<P>Shared libraries are the only option available in Java. When you create a .class file, it is a shared library. Like a shared library, a parent thread can invoke any method of the class. It is easy to pass complex data from parent to child.</P>
<P>A collection of shared libraries in Java is a package. A package is a class library. Many of the benefits of the Java model are available in C++.</P>
<P>The composition (memory layout) of a class in Java is determined at run-time. Unlike C++, Java does not have a <CODE>sizeof()</CODE> macro. The size of a class depends on a virtual machine and class file. Both the declaration (interface) and definition (implementation) of a class is stored together in one .class file.</P>
<P>A Java Virtual Machine assumes all libraries (or class files) are shared. Unlike C++, a standard Java compiler has no options to produce non-shared code.</P>
<H4><CODE>SharedLibrary</CODE> class in C++</H4>
<P><CODE>SharedLibrary</CODE> is a new class in C++. It is a platform-independent model for using shared libraries. The <CODE>SharedLibrary</CODE> class itself is a pure virtual class. It has a size of zero.</P>
<P>Here is a C++ class definition from <CODE>sharedlibrary.h</CODE>.</P>
<PRE>
SharedLibrary createSharedLibrary( const char *v );

class SharedLibrary {
  public:
	 /**
	  * Gets Name property.
	  */
	 virtual CharBuffer getName() const = 0;

	 /**
	  * Sets Name property.
	  */
	 virtual void setName( const char *v ) = 0;

	 /**
	  * Gets Method property.
	  */
	 virtual void *getMethod( const char *v ) const = 0;

	 /**
	  * Assignment operator.
	  */
	 const SharedLibrary &amp;operator=( const char * ) = 0;

	 /**
	  * Assignment operator.
	  */
	 const SharedLibrary &amp;operator=( const SharedLibrary &amp;v ) = 0;
};
</PRE>
<H4>Name property</H4>
<P>The name property holds the name of the shared library. It is possible to use the same instance to open different libraries. Each instance can only open one shared library at a time.</P>
<H4>Method property</H4>
<P>The method property is read-only. The entry point of a method is returned (if possible) for a given method name.</P>
<H4><CODE>CharBuffer</CODE> class</H4>
<P>A <CODE>CharBuffer</CODE> class is provided for automatic garbage collection of strings manufactured by the <CODE>SharedLibrary</CODE> class.</P>
<H4>Platform independent</H4>
<P>The <CODE>SharedLibrary</CODE> class is platform independent. Although Linux and Windows use different methods to load and unload a shared library, the <CODE>SharedLibrary</CODE> class is identical on both platforms.</P>
<P>Here is a trick question:</P>
<P><EM>How is the <CODE>SharedLibrary</CODE> class implemented on Linux? on Windows?</EM></P>
<P>In C++, a pure virtual class is declared and defined within a header file. A pure virtual class is not implemented like other classes. Only an extension of <CODE>SharedLibrary</CODE> is implemented.</P>
<P><EM>Where is the <CODE>sharedlibrary.cpp</CODE> file?</EM></P>
<P>There is none. We don't need <CODE>sharedlibrary.cpp</CODE> for a pure virtual class.</P>
<H4>On Linux</H4>
<P>The Linux-specific version of <CODE>SharedLibrary</CODE> is <CODE>LinuxSharedLibrary</CODE>. Its declaration is found in <CODE>linuxsharedlibrary.h</CODE>.</P>
<PRE>
class LinuxSharedLibrary : public SharedLibrary {
  public:
	 LinuxSharedLibrary();
	 LinuxSharedLibrary( const char *v );
	 virtual ~LinuxSharedLibrary();
	 virtual CharBuffer getName() const;
	 virtual void setName( const char *v );
	 virtual void *getMethod( const char *v ) const;
	 const SharedLibrary &amp;operator=( const char * );
	 const SharedLibrary &amp;operator=( const SharedLibrary &amp;v );

  protected:

  private:
	 CharBuffer name;
	 void *handle;
};
</PRE>
<P>Its implementation is found in <CODE>linuxsharedlibrary.cpp</CODE>.</P>
<PRE>
SharedLibrary &amp;createSharedLibrary( const char *v ) {
  return new LinuxSharedLibrary( v );
}

LinuxSharedLibrary::LinuxSharedLibrary() {
  handle = NULL;
}

LinuxSharedLibrary::LinuxSharedLibrary( const char *v ) {
  handle = NULL;
  setName( v );
}

LinuxSharedLibrary::LinuxSharedLibrary( const SharedLibrary &amp;v ) {
  handle = NULL;
  setName( v.getName() );
}

LinuxSharedLibrary::~LinuxSharedLibrary() {
  if ( handle ) {
	 dlclose( handle );
  }
}

CharBuffer LinuxSharedLibrary::getName() const {
  return name;
}

void LinuxSharedLibrary::setName( const char *v ) {
  if ( handle ) {
	 dlclose( handle );
  }
  handle = dlopen( v );
  if ( handle ) {
	 name = v;
  }
}

void *LinuxSharedLibrary::getMethod( const char *v ) const {
  if ( handle ) {
	 return dlsym( handle, v );
  }
  return NULL;
}

const SharedLibrary &amp;
LinuxSharedLibrary::operator=( const char *v ) {
  setName( v );
  return *this;
}

const SharedLibrary &amp;
LinuxSharedLibrary::operator=( const SharedLibrary &amp;v ) {
  if ( &amp;v = this ) {
	 return v;
  }

  setName( v.getName() );
  return v;
}
</PRE>
<H4>On Windows</H4>
<P>The Windows-specific version of <CODE>SharedLibrary</CODE> is <CODE>WindowsSharedLibrary</CODE>. Its declaration is found in <CODE>windowssharedlibrary.h</CODE>.</P>
<PRE>
class WindowsSharedLibrary : public WindowsLibrary {
  public:
	 WindowsSharedLibrary();
	 WindowsSharedLibrary( const char *v );
	 WindowsSharedLibrary( const SharedLibrary &amp;v );
	 virtual ~WindowsSharedLibrary();
	 virtual CharBuffer getName() const;
	 virtual void setName( const char *v );
	 virtual void *getMethod( const char *v ) const;
	 const SharedLibrary &amp;operator=( const char * );
	 const SharedLibrary &amp;operator=( const SharedLibrary &amp;v );

  protected:

  private:
	 CharBuffer name;
	 HINSTANCE hinstance;
};
</PRE>
<P>Its implementation is found in <CODE>windowssharedlibrary.cpp</CODE>.</P>
<PRE>
SharedLibrary &amp;createSharedLibrary( const char *v ) {
  return new WindowsSharedLibrary( v );
}

WindowsSharedLibrary::WindowsSharedLibrary() {
  hinstance = NULL;
}

WindowsSharedLibrary::WindowsSharedLibrary( const char *v ) {
  hinstance = NULL;
  setName( v );
}

WindowsSharedLibrary::WindowsSharedLibrary( const SharedLibrary &amp;v ) {
  hinstance = NULL;
  setName( v.getName() );
}

WindowsSharedLibrary::~WindowsSharedLibrary() {
  if ( hinstance ) {
	 FreeLibrary( hinstance );
  }
}

CharBuffer WindowsSharedLibrary::getName() const {
  return name;
}

void WindowsSharedLibrary::setName( const char *v ) {
  if ( hinstance ) {
	 FreeLibrary( hinstance );
  }
  hinstance = LoadLibrary( v );
  if ( hinstance ) {
	 name = v;
  }
}

void *WindowsSharedLibrary::getMethod( const char *v ) const {
  if ( hinstance ) {
	 return GetInstanceFunction( hinstance, v );
  }
  return NULL;
}

const SharedLibrary &amp;
WindowsSharedLibrary::operator=( const char *v ) {
  setName( v );
  return *this;
}

const SharedLibrary &amp;
WindowsSharedLibrary::operator=( const SharedLibrary &amp;v ) {
  if ( &amp;v = this ) {
	 return v;
  }

  setName( v.getName() );
  return v;
}
</PRE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FSharedLibrary&PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FSharedLibrary&PHPSESSID=e4a335c86bd241e22b4b1080d3dc6c88">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

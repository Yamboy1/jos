<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>JJOSObjectProperty.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="23c66e6fcce0257894f0034dbc365bca" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//JJOSObjectProperty?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">JJOSObjectProperty</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=23c66e6fcce0257894f0034dbc365bca" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=23c66e6fcce0257894f0034dbc365bca"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/JJOSObjectProperty?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">info</a> on or <a href="/edit/Imported/JJOSObjectProperty?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FJJOSObjectProperty&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FJJOSObjectProperty&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=23c66e6fcce0257894f0034dbc365bca">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=JJOSPages&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">JJOSPages</a><wikitopic JJOSPages /wikitopic></FONT>
<HR SIZE="1" NOSHADE>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (5 April 2001).</EM></P>
<H4>Introduction</H4>
<P>The <CODE>java_object</CODE> class could be expanded to provide convienent properties. One of these is the Array property.</P>
<P>What is the relationship between <CODE>java_object</CODE> and <CODE>java_string</CODE>? It might be better if an instance of <CODE>java_string</CODE> uses an instance of <CODE>java_object</CODE> than if the <CODE>java_string</CODE> class extends the <CODE>java_object</CODE> class.</P>
<H4>Array property</H4>
<P>An object can be either an object or an array. The array property is read-only and shows whether an object is an array or not.</P>
<PRE>
  public:
	 :
	 virtual bool isArray() const;
</PRE>
<P>When an object is an array, it can be used in the <CODE>System.arraycopy()</CODE> method. This native method is implemented in the <CODE>java_lang_System_arraycopy()</CODE> function in <CODE>jvmbuiltins.cc</CODE>.</P>
<H4>Example</H4>
<P>Your machine language program can determine if an object is an array by invoking the <CODE>isArray()</CODE> method. This method returns true only if an object is an array.</P>
<PRE>
void example( java_object *v ) {
  if ( v-&gt;isArray() ) {
  :
  }
  else {
  :
  }
}
</PRE>
<H4><CODE>java_jint_array</CODE> class</H4>
<BLOCKQUOTE><EM>Someday, it may be much easier to create an integer array in machine code.</EM></BLOCKQUOTE>
<P>The machine code equivalent inside decaf virtual machine of Java's <CODE>int[]</CODE> is the <CODE>java_jint_array</CODE> class. Unfortunately, this class can be difficult to use. Its constructor is obscure and evasive. It is obscure because it requires a pointer to the corresponding <CODE>[I</CODE> class. It is evasive because, so far, it is not obvious how to obtain a reference to the <CODE>[I</CODE> class.</P>
<H4><CODE>java_string</CODE> class</H4>
<BLOCKQUOTE><EM>Someday, it may be much easier to create an instance of <CODE>java/lang/String</CODE> in machine code.</EM></BLOCKQUOTE>
<P>The machine code equivalent of Java's <CODE>java/lang/String</CODE> is the <CODE>java_string</CODE> class. Unfortunately, this class does yet not meet our requirements. When constructing an instance of <CODE>java/lang/String</CODE>, an equivalent constructor must be invoked. Machine code must be able to use the current frame to invoke the bytecode constructor, or rather run equivalent of <CODE>invokespecial</CODE> for the <CODE>&lt;init&gt;</CODE> method.</P>
<P>A variety of string tests have failed because the <CODE>java_string</CODE> class does not yet meet our requirements. Here are the steps required to convert a constant UTF8 entry in codepool to an instance of <CODE>java/lang/String</CODE>:</P>
<OL>
<LI><P>Convert from UTF8 to unicode.</P>
<P>This machine code function converts 8-bit <a href="/view.php?topic=UTF&web=Imported&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">UTF</a> <wikitopic UTF /wikitopic>to 16-bit unicode. This function must return the number of unicode characters which have been converted. Multiple 8-bit <a href="/view.php?topic=UTF&web=Imported&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">UTF</a> <wikitopic UTF /wikitopic>can produce a single 16-bit unicode.</P>
<LI><P>Create an instance of Java's <CODE>char[]</CODE>.</P>
<P>From a machine code array of unicode characters, an equivalent <CODE>char</CODE> array must be created, subject to garbage collection.</P>
<P>The <CODE>java_jint_array</CODE> class seems to be the only class available for storing an array of Java <CODE>char</CODE>s.</P>
<LI><P>Create an instance of Java's <CODE>java/lang/String</CODE>.</P>
<P>In machine code, assign (<CODE>putfield</CODE>) a reference to the above object (<CODE>char[]</CODE>) to the <CODE>value</CODE> field. Assign the length of the array to the string's <CODE>length</CODE> field.</P>
</OL>
<H4>About multiple heaps</H4>
<P>From machine code, it is important to store an instance of <CODE>java/lang/String</CODE> and its <CODE>value</CODE> field together on a process heap. Therefore, a process (environment) must be passed to the constructor of <CODE>java_string</CODE>. When a process dies, both the <CODE>char[]</CODE> and <CODE>java/lang/String</CODE> are free'd.</P>
<H4>Optimization</H4>
<P>As part of its definition, the <CODE>ldc</CODE> opcode pushes a reference to <CODE>java/lang/String</CODE> on a process stack. Once a codepool entry has been converted from a constantUTF8 to <CODE>java/lang/String</CODE>, it is not necessary to perform the conversion again. The <CODE>ldc</CODE> opcode can return the same object reference multiple times. A string is final, immutable.</P>
<P>When a class is <EM>resolved</EM> for a process, <CODE>Constant.STRING</CODE> entries in codepool can be converted to instances of <CODE>java/lang/String</CODE>. Or, conversion can be handled by the <CODE>ldc</CODE> opcode as needed.</P>
<H4>Another way</H4>
<P>There is another way. Since everything that can be written in bytecode should be, it might be possible to write a Java class which is capable of creating an instance of the <CODE>java/lang/String</CODE> class.</P>
<PRE>
public interface StringFactory {
  public abstract String getStringFromUTF8( byte[] constant_utf8 );
  public abstract String getStringFromUnicode( char[] unicode );
}
</PRE>
<P>Here is a possible implementation.</P>
<PRE>
public class DecafStringFactory
	 implements StringFactory {
  public DecafStringFactory() {
  }
  public String getStringFromUTF8( byte[] constant_utf8 ) {
	 int iMax = constant_utf8.length;
	 char[] buf = new char[ iMax ];
	 int t = 0;
	 for ( int i = 0; i &lt; iMax; i++ ) {
		byte x = constant_utf8[ i ];
		:
		buf[ t++ ] = (char) x;
	 }
	 return new String( buf, 0, t );
  }
  public String getStringFromUnicode( char[] unicode ) {
	 return new String( unicode, 0, unicode.length );
  }
}
</PRE>
<P>In machine code, a function can be designed which invokes the <CODE>DecafStringFactory.getStringFromUTF8()</CODE> method in the constructor of <CODE>java_string</CODE>. The <CODE>java_string</CODE> class should hold a reference to an instance of <CODE>java/lang/String</CODE> and provide <CODE>getLength()</CODE> and other methods.</P><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FJJOSObjectProperty&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FJJOSObjectProperty&PHPSESSID=23c66e6fcce0257894f0034dbc365bca">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

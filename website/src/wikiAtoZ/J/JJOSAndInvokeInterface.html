<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>JJOSAndInvokeInterface.Main @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="d4bd69df4119e16031f94a1d3acbac44" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//JJOSAndInvokeInterface?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">JJOSAndInvokeInterface</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Main/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">Main</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Main/JJOSAndInvokeInterface?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">info</a> on or <a href="/edit/Main/JJOSAndInvokeInterface?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FJJOSAndInvokeInterface&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FJJOSAndInvokeInterface&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Main/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">topics</a>, <a href="/hubsnodes/Main/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Main/?PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<a href="/view.php?topic=JJOSPages&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">JJOSPages</a><wikitopic JJOSPages /wikitopic>
<HR>
<EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (21 June 2001).</EM>
<H4>Introduction</H4>
This article is a project update. Recently, the invokeinterface opcode was a suspect in a hunt for keyboard interrupts. The decaf interpreter seemed to fail at an abstract method with no Code attribute. What is the invokeinterface opcode supposed to do? Here is the result of my research.
<H4>Interface class</H4>
The first class involved in this discussion is the interface class itself. By definition, an interface class contains abstract methods with no Code attribute. If a method has no Code attribute it cannot be invoked directly; it must be invoked indirectly.
</P><P>
Every method of an interface must be abstract. An abstract method should not have a Code attribute. Even if an abstract method were to have a Code attribute, its Code attribute must be ignored. If an interface method cannot be invoked, what is the point of invoking an interface method? The most important part of an interface method is its key. A key is the method name and descriptor. A method key from an interface method is used to look up a method in another class.
</P><P>
So, the interface class does not contain the Code attribute we're looking for. Can we use the current class? No.
<H4>Current class</H4>
We turn our attention to the current class inside the interpreter. The operand for the invokeinterrupt opcode is an interface method reference. As it interprets the Code attribute, the opcode method for invokeinterface finds an interface method. The interface method points to the interface class.
</P><P>
So, neither the interface class nor the current class contain the Code attribute we're looking for. If these classes don't contain the Code attribute we're looking for, which class contains it? The <EM>this</EM> class.
<H4>The <EM>this</EM> class</H4>
Using the method's key (name and descriptor), the interpreter must look up the corresponding method in the class of the <EM>this</EM> object. The <EM>this</EM> parameter is an object. It is a hidden parameter. It is called "this" in terms of the Java programming language. It might be called argument zero in terms of the Java Virtual Machine. It is found on the local variable (operand) stack.
</P><P>
The interpreter finds the <EM>this</EM> object and gets its class. The class of the <EM>this</EM> object may contain the Code attribute we're looking for.
</P><P>
At this point, invoking an interface is much like invoking any virtual method. Starting with the <EM>this</EM> class, the interpreter searches recursively for a method with the given key. If a class does not contain a concrete method with a Code attribute, the search continues with its superclass and so on. The search continues until a matching method is discovered or there is no superclass. (The java/lang/Object class has no superclass.)
<H4>Validation</H4>
The search should only return a concrete method. If the search reaches an abstract method, an exception is thrown.
</P><P>
The return value from an interface method should match the return value type of any method that's found. No additional check is necessary because the return value is part of the method's key. Matching the key guarantees a matching return value type.
<H4>Optimization</H4>
Here is one possible optimization. If the <EM>this</EM> object is an instance of the resolved method's class, the search will always return the original resolved method. Here is the optimization in C++:
<PRE>
  const resolved_method *
  java_class::lookupMethod(
      const resolved_method *rm
      ) {
    if ( this == rm-&gt;getClass() ) {
      return rm;
    }
    :
  }
</PRE>
<H4>Method table</H4>
The method table is an array of method_info objects. Release 14 adds the getMethod() method to this class, so that a corresponding resolved method can returned from the method table.
</P><P>
The java_class::resolveMethodTable() method creates an instance of
<CODE>resolved_method</CODE> for each method in the method table. The
<CODE>resolved_method</CODE> object is stored in the corresponding
<CODE>method_info</CODE> object.
<PRE>
  void example( const java_class *c, int methodref ) {
    method_info *info = c-&gt;methods-&gt;operator[]( methodref );
    if ( info == NULL ) {
      return;
    }

    const resolved_method *rm = info-&gt;getMethod();
    if ( resolved_method == NULL ) {
      // method has not yet been linked with resolveMethodTable().
      return;
    }
    :
  }
</PRE>
The resolveMethodTable() method can be invoked more than once; methods will only be resolved once.
<PRE>
    method_info *info = methods-&gt;operator[]( i );
    if ( info == NULL ) {
      continue;
    }
</PRE>
<H4>Optimization 2</H4>
The method table of a given class cannot be optimized to look up each method immediately, rather than waiting for a method to be invoked. If a method is abstract, the <EM>this</EM> class is unknown.
</P><P>
A myMethod field and getMethod() method could be made part of the constant pool's methodref and interfacemethodref classes. This would enable a search for an interface method to be saved within constant pool of a class. The lookupMethod() method could determine if it has been invoked before on a given class and method key. If getMethod() method returns a resolved method, the search has already been performed; it does not need to be performed again. If it returns a <CODE>NULL</CODE> value, a search has not yet been performed.
<H4>Summary</H4>
Invoking an interface is like invoking any virtual method, except the method's key comes from an interface class instead of an abstract or concrete class.
<HR>
I'm pretty sure <a href="/view.php?topic=ToddMiller&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">ToddMiller</a><wikitopic ToddMiller /wikitopic> and I agree about how the invokeinterface opcode should work. I'm more confident now that the invokeinterface and invokevirtual opcodes in <a href="/view.php?topic=JJOS&web=Main&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">JJOS</a> <wikitopic JJOS /wikitopic>1i-14 are implemented correctly. Both the invokeinterface and invokevirtual opcodes start with the "this" class when searching for a method.
</P><P>
A "current class" is the currently executing class. It is the class closely associated with calling method. When referring to the "current class", I believe I correctly stated it this way:
</P><P>
The current class <EM>does not contain the Code attribute we're looking for.</EM>
</P><P>
Maybe I don't write so well. Todd's right: the currently executing class is not the root of the search. Could I have been more explicit? As a summary of the article up to that point, I might have said:
</P><P>
<EM>So, neither the interface class nor the current class contains the Code attribute we're looking for.</EM>
</P><P>
If neither the interface class nor the current class are the root of the search, which class contains the Code attribute we're looking for? (Or, which class is the root of the search?) It is the class of a specific object from the stack. The object is called "this" in terms of the Java programming language. It might be called argument zero in terms of the Java Virtual Machine.
</P><P>
The class of the "this" object is the "this" class. It is the "this" class that should be the root of the search. As I wrote:
</P><P>
"Starting with the 'this' class, the interpreter searches recursively for a method with the given key."
</P><P>
-- <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (22 June 2001)<BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FJJOSAndInvokeInterface&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FJJOSAndInvokeInterface&PHPSESSID=d4bd69df4119e16031f94a1d3acbac44">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>DecafMain.Main @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="809f3974fb4e9d9cbf2aab030affdece" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//DecafMain?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">DecafMain</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Main/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">Main</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Main/DecafMain?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">info</a> on or <a href="/edit/Main/DecafMain?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FDecafMain&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FDecafMain&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Main/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">topics</a>, <a href="/hubsnodes/Main/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Main/?PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<a href="/view.php?topic=JJOSPages&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">JJOSPages</a><wikitopic JJOSPages /wikitopic>
<HR>
<EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (17 June 2003).</EM>
<H4>Introduction</H4>
This is where it begins. This article provides step-by-step documentation for the start-up sequence for decaf, with a goal of determining where classes are loaded from a ramdisk.
</P><P>
The source code file is <CODE>cpp/decaf/d_main.cpp</CODE>.
<H4>From jjos to decaf-main()</H4>
After installing the kernel environment, the jjos kernel always invokes the decaf-main() function.
<PRE>
void decaf_main( int argc, char ** argv, jjMachine * jjmp, jbRamDisk * rd );
</PRE>
<UL> <LI> The name of this function is very product-specific. Its name ought to reflect that other products can be built upon the jjos kernel.
<LI> The jjMachine object represents the jjos kernel. There is only one instance of jjMachine. It does not need to be passed from jjos to decaf explicitly. A decafJVM object can discover <nolink>THE jjMachine using <CODE>extern jjMachine * jjm</CODE>.
<LI> The jbRamDisk object represents the ramdisk. The ramdisk contains class files in a the un-compressed ZIP-compatible archive. There is only one instance of jbRamDisk; it does not need to be passed from jjos to decaf either. A decafJVM object can discover <nolink>THE jbRamDisk.
</UL> <H4>From decaf-main() to decafJVM object</H4>
Within the decaf-main() function, an instance of decafJVM is created.
<PRE>
  jvm = new decafJVM( jjmp, rd );
</PRE>
<UL> <LI> The decafJVM object represents the virtual machine. This code assumes that there is only one instance of a virtual machine, the primary one. The variable is declared as <CODE>decafJVM *jvm = NULL;</CODE>, enabling other modules to discover <nolink>THE virtual machine.
<LI> The jjMachine and jbRamDisk are passed thru decaf-main() to the decafJVM constructor.
</UL> 
The main thread is attached to the virtual machine by invoking its main() method.
<PRE>
  jvm-&gt;main( argc, argv );
</PRE>
<H4>The decafJVM constructor</H4>
Here are the steps.
<STRONG>Step 1.</STRONG> A ramdisk (jbRamDisk) is passed to the decafJVM constructor. The very first action in the constructor is to set up a primordial class loader using the given ramdisk. A virtual machine has-a primordial class loader. System classes are loaded using it.
<PRE>
  myPrimordialClassLoader = new class_loader( rd );
</PRE>
</P><P>
<STRONG>Step 2.</STRONG> A jjos kernel (jjMachine) is passed to the constructor. This is also saved as myjjMachine.
<PRE>
  myjjMachine = jjmp;
</PRE>
</P><P>
<STRONG>Step 3.</STRONG> The constructor now turns its attention to built-in methods. All of its built-in methods are expected to be installed and ready-to-run before the first Java class is loaded. It builds a hashtable
<PRE>
  myBuiltinMethods = new builtinMethodHashTable( 128 );
</PRE>
and installs its built-in methods.
<PRE>
  internBuiltInMethods();
</PRE>
<UL> <LI> <EM>Caution:</EM> Some of the built-in methods do not correspond one-to-one with a native method in a Java class. This is less than ideal. For example, every method called "start" was assumed to be a Thread.start(), so that some threads are not required to extend Thread. Ideally, each built-in method would correspond to exactly one native method.
</UL> 
<STRONG>Step 4.</STRONG> The constructor finishes with by initializing the scheduler. The scheduler must be initialized at exactly the right moment.
<PRE>
  myScheduler.init();
</PRE>
<H4>The decaf::main() method</H4>
The decaf-main() function invokes the decaf::main() method.
</P><P>
<STRONG>Part 1.</STRONG> This is where attention is given the command line arguments. Command line arguments are passed to the jjos kernel. In turn, they are passed to the decaf-main() function and then to the decaf::main() method.
</P><P>
The name of the start-up class is the second argument, argv[ 1 ]. The default start-up class is "init". The default start-up method is "main".
</P><P>
<STRONG>Part 2.</STRONG> The first thread, thread zero, is created. The class and method names are passed to the thread's constructor, along with <nolink>THE primordial class loader.
<PRE>
  java_thread * zeroth_thread =
      new java_thread(
          classname,
          methodname,
          myPrimordialClassLoader,
          (java_word *)NULL,
          0
          );
</PRE>
</P><P>
<STRONG>Part 3.</STRONG> The decaf::main() method adds the thread to a scheduler and then starts the thread.
<PRE>
  myScheduler.addThread( zeroth_thread );
  myScheduler.start(
      myjjMachine,
      myPrimordialClassLoader-&gt;getClass(
          constant_utf8( "jos/system/interrupts" ).string(),
          zeroth_thread
          ));
</PRE>
<UL> <LI> <EM>Question:</EM> A class is a parameter to the scheduler::start() method. Why is the jos/system/interrupts class used here?
</UL> <H4>Finding a system class</H4>
It is possible to find a system class from any module. The following code illustrates the technique.
</P><P>
There is only one instance of decafJVM called jvm. It can be discovered, like this:
<PRE>
extern decafJVM * jvm;
</PRE>
A decafJVM has only one primordial class loader. It can be discovered and a system class can be found, something like this:
<PRE>
java_class * example1( java_thread * t, const char * cn ) {
  if ( jvm == NULL ) {
    // jvm has not yet been constructed.
    return NULL;
  }

  class_loader cl =
      jvm-&gt;getPrimordialClassLoader();

  return
      cl-&gt;getClass( constant_utf8( cn ).string(), t );
}
</PRE>
Or rather, a system class is found using the <CODE>java_thread::FindSystemClass()</CODE> method.
<PRE>
java_class * example2( java_thread * t, const char * cn ) {
  return t-&gt;FindSystemClass( cn );
}
</PRE>
<UL> <LI> <EM>Question:</EM> A thread, or JNIEnv, must be passed to the class_loader::getClass() method, so it can recursively resolve system classes. How does this affect the thread's state? Ideally, the thread's state should be restored.
<LI> <EM>Question:</EM> Is it possible for a non-preemptive scheduler to switch threads while a system class is being resolved?
<LI> <EM>Question:</EM> How and when is the <nolink>NoClassDefException exception thrown?
</UL> <H4>One thread per class</H4>
Some classes have a static initialization method called <CODE>&lt;clinit&gt;</CODE>. This method always has the same signature, as in <CODE>&lt;clinit&gt;()V</CODE>, accepts no parameters and returns nothing. In decaf, each class has a <CODE>static-init</CODE> property which corresponds to this method. This property is a thread. Whenever a class has this method, a new thread is created.
</P><P>
The <CODE>java_class::doStaticInitializationIfNecessary()</CODE> method completes the <CODE>static-init</CODE> thread, which invokes the <CODE>&lt;clinit&gt;</CODE> method. Here is how a thread is run to completion:
<PRE>
  while ( t-&gt;runOpcode() );
</PRE>
<UL> <LI> Ideally, it should be possible to invoke the static initialization method without creating a new thread. A stackframe should be pushed onto the current thread's stack. The <CODE>runOpcode()</CODE> method should be invoked repeatedly until that stackframe is popped off of the stack.
<LI> <EM>Throwing an exception:</EM> It is possible to throw an exception inside a static initialization method. When an exception is thrown, the exception property of the current thread should be set. The calling Java method can handle the exception. Again, this lends itself to having the current thread invoke the static initialization method.
<LI> The <a href="/view.php?topic=JavaNativeInterface&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">JavaNativeInterface</a><wikitopic JavaNativeInterface /wikitopic> does not provide a method to invoke a static initialization method directly. A <CODE>CallStaticInitializationMethod()</CODE> method might correspond loosly to the invokespecial opcode.
<LI> The run-to-completion logic for a thread should be encapsulated in a method of a thread. Further, a similar method should be capable of pushing a new stackframe on an existing thread and running the thread until a specific stackframe is popped. See the java-thread::run() method.
<LI> Since the current thread has the ability to run the static initialization method, it is no longer necessary to create a new thread for each class. Exceptions can be thrown within <CODE>&lt;clinit&gt;</CODE>. And further, appropriate exceptions can be thrown in C++ by the class resolver methods.
</UL> <H4>Calling a static initialization method</H4>
The static initialization method, or <CODE>&lt;clinit&gt;()V</CODE>, must be invoked only once. The <CODE>initialized</CODE> property is now part of the <CODE>java-class</CODE> class. It defaults to false, or not yet initialized. To get this property, use <CODE>isInitialized()</CODE>; to set this property, use <CODE>setInitialized()</CODE>. Once set, it cannot be reset.
</P><P>
The <CODE>CallStaticInitializationMethod()</CODE> method is now part of the <CODE>java-thread</CODE> class. Its only parameter is a <CODE>java-class</CODE>. This method invokes the static initialization method if necessary. It depends on the <CODE>java-thread::run()</CODE> method.
</P><P>
To run a thread to completion, invoke a thread's run() method with a <nolink>NULL parameter, like this:
<PRE>
  t-&gt;run( NULL );
</PRE>
</P><P>
To invoke a method using an existing thread, create a stack frame and pass it to a thread's run() method, like this:
<PRE>
  void example( frame * f ) {
    t-&gt;run( f );
  }
</PRE>
<UL> <LI> <EM>Throwing an exception.</EM> Any unhandled exception thrown by the frame will be stored in the exception property of the original current frame.</UL> <BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FDecafMain&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FDecafMain&PHPSESSID=809f3974fb4e9d9cbf2aab030affdece">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

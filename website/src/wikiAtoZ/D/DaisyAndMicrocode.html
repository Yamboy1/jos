<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>DaisyAndMicrocode.Main @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="2aa96c3efc9d25ae6e8355a3db0076bc" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//DaisyAndMicrocode?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">DaisyAndMicrocode</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Main/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">Main</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Main/DaisyAndMicrocode?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">info</a> on or <a href="/edit/Main/DaisyAndMicrocode?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FDaisyAndMicrocode&PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FDaisyAndMicrocode&PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Main/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">topics</a>, <a href="/hubsnodes/Main/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Main/?PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<a href="/view.php?topic=DaisyOSPages&PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">DaisyOSPages</a><wikitopic DaisyOSPages /wikitopic>
<HR>
<EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (14 December 2002).</EM>
<H4>Introduction</H4>
Here is another kind of code. There is source code and machine code and bytecode. But what is microcode? It is a mechanism for reducing an instruction set to its component parts.
</P><P>
In a thorough examination of the instruction set for a Java Virtual Machine, you'll find that there are patterns within it. A more reliable virtual machine might be possible by studying these patterns and reducing them to microcode within your software.
</P><P>
Let's take the iload instructions as an example. In fact, you'll find them identical in implementation to the bload and cload and fload and sload instructions. All of these are reduced to storing a value to a 32-bit local variable. While other virtual machine designers might write a subroutine for each of the instructions in the instruction set, we are going to examine writing a single subroutine for storing a value to a 32-bit local variable, like this:
  store32( cint32 n, cint32 v );
where n is an index of a local variable and v is a value to be stored.
<H4>Flags</H4>
How does a processor know when to invoke the store32() method? For each instruction that stores a value in a 32-bit local variable, a flag is set. In an array of 256 elements, one element corresponding to each of the narrow opcodes, most of the flags are not set because they do not invoke the store() method. Only the opcodes that store a value have their flags set.
</P><P>
This seems to suggest a Microcode class. This class provides methods to set and get each of the microcode flags. When a processor encounters an opcode, it looks up the corresponding instance of the Microcode class:
<PRE>
  Microcode *m = mc_getMicrocode( opcode );
</PRE>
A flag must be tested to determine when an opcode invokes the store..() method.
<PRE>
  if ( m-&gt;isStore32() ) {
    store32( n, v );
  }
  if ( m-&gt;isStore64() ) {
    store64( n, v1, v2 );
  }
</PRE>
Where does n and v come from? There are differences in the bload, cload, fload and iload instructions. The part that is different can be confined to a specific opcode method. Parts that are identical can be implemented in microcode. When your subroutine properly stores any 32-bit value and flags are set properly within your microcode manager, you've implemented part of many instructions, not just one.
<H4>Objects</H4>
A local variable can hold a simple 32-bit value or a 32-bit reference to an object. The object-related instructions are implemented differently than those for simple values. In garbage collection, your virtual machine must be able to distinguish between a simple value and an object reference.
</P><P>
A bit array can be useful here. One array holds 32-bit values. Another array holds one bit for each local variable. When an object is stored, the corresponding bit is set. When a simple value is stored, the corresponding bit is reset.
<H4>Pre-configured</H4>
The microcode manager is configured at compile-time. It must be carefully maintained so that flags are set exactly as they should be. Some reasonability tests are possible so that flags are consistent. For example, no opcode is able to store both a 32-bit and 64-bit value. When a flag is set for the one, it should not be set for the other; they are mutually exclusive.
</P><P>
This technique can also simplified the modification of the program counter (pc). It is determined at compile-time for most of the instructions how much to increment pc.
<PRE>
  if ( mc-&gt;isIncrementBy1() ) {
    pc++;
  }
  if ( mc-&gt;isIncrementBy2() ) {
    pc += 2;
  }
  if ( mc-&gt;isIncrementBy3() ) {
    pc += 3;
  }
</PRE>
For those instructions that have no operands (values within the code), their flag is set for increment<EM>by</EM>1. For those with a 8-bit operand, their flag is set for increment<EM>by</EM>2. For those with a 16-bit operand, their flag is set for increment<EM>by</EM>3. For those with a 32-bit operand, their flag is set for increment<EM>by</EM>5.
</P><P>
There is a corrolary. If it is necessary to increment by 2, an 8-bit value must be extracted from within the code. This can be done generically, before invoking an opcode method. When extracted, an unsigned 8-bit value is stored without convertion into t1, an unsigned 32-bit variable in C. An opcode method is not required to have access to the code, an array of 8-bit values.
</P><P>
If it is necessary to increment by 3, a 16-bit value must be extracted. As with an 8-bit value, an unsigned 16-bit value is stored without conversion into an unsigned 32-bit variable in C.
</P><P>
If it is necessary to increment by 5, a 32-bit value must be extracted. Again, an unsigned 32-bit value is stored without conversion into an unsigned 32-bit variable in C. This variable is part of the processor's current stack frame.
</P><P>
If it is necessary to increment by 9, a 64-bit value must be extracted. An unsigned 32-bit value is stored in variable t1 and another 32-bit value is stored in variable t2.
<H4>Conversion</H4>
When performing special conversion to maintain the proper behavior of a Java Virtual Machine, conversion subroutines are useful. But these do not operate on local variables directly. Only variables within the current stack frame are used. A conversion routine modifies a value within the current stack frame.
</P><P>
Let's take a look at a break down of the int-to-byte (i2b) conversion.
<OL> <LI> Using an index, a local variable is copied to t1.
<LI> The i2b() opcode method converts an int in t1 to a byte and stores the result in t1.
<LI> Using an index, t1 is copied to a local variable.
</OL> 
Getting a value from a local variable is a generic function.
<PRE>
  fetch32( cint32 n );
</PRE>
The fetch32() method copies a local variable indexed by n to t1. Every instruction that needs to fetch a local variable is flagged in microcode. The generic code looks something like this:
<PRE>
  if ( m-&gt;isFetch32() ) {
    fetch32( n );
  }
  if ( m-&gt;isFetch64() ) {
    fetch64( n );
  }
</PRE>
Likely, a conversion instruction has its flag set for a fetch and a store, with a conversion subroutine invoked between the fetch and store.
<H4>Processor</H4>
Writing in the C++ programming language, an abstract processor class can implement the generic methods, such as fetch32(), fetch64(), store32() and store64(). A base class does not need one method for each opcode. It can implement generic code to maintain the proper program counter. It can implement generic code to read opcode and operand from the code.
</P><P>
A concrete processor class puts the finishing touches on the specific implementation of a processor. At compile-time, more than one concrete processor class can be made available to your Java-based operating system to enable you to support different features, such as debugging vs. optimized, standard vs. extended, production vs. experimental. When you create an instance of your Java Virtual Machine at run-time, you bind your application to a specific processor.<BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FDaisyAndMicrocode&PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FDaisyAndMicrocode&PHPSESSID=2aa96c3efc9d25ae6e8355a3db0076bc">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

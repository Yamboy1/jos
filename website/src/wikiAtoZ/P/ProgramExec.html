<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>ProgramExec.Main @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="f22f8d0933be84c0e48ae15bb150258c" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//ProgramExec?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">ProgramExec</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Main/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">Main</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Main/ProgramExec?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">info</a> on or <a href="/edit/Main/ProgramExec?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FProgramExec&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FProgramExec&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Main/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">topics</a>, <a href="/hubsnodes/Main/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Main/?PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<a href="/view.php?topic=ProgramContext&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">ProgramContext</a><wikitopic ProgramContext /wikitopic>
<HR>
<EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (1 March 2000).</EM>
<H4>Introduction</H4>
When a console-style program is running, it can easily invoke other programs with an <CODE>exec()</CODE> method, something like this:
<PRE>
  protected int exec( String v ) {
    URI uri = new URI( v );
    Program p;
    try {
      p = (Program) uri.getObject();
    }
    catch( ClassCastException e ) {
      _print( e );
      return -1;
    }

    if ( p instanceof ConsoleProgram ) {
      ((ConsoleProgram) p).setConsole( this );
    }

    try {
      p.run();
    }
    catch( Throwable e ) {
      _print( e );
      return -1;
    }

    rc = p.getProgramContext().getResultCode();

    if ( p instanceof ConsoleProgram ) {
      ((ConsoleProgram) p).setConsole( this );
    }

    return rc;
  }
</PRE>
The parent program waits for the child program to run. A parent gets a result code (int) from the child's program context.
<H4>Subprograms</H4>
When invoked by another, a program is called a <EM>subprogram</EM>. Subprograms are important in classic data processing and extreme reuse.
<H4>Server-side programs</H4>
A subprogram is easily used in a complex Java servlet. A program-compatible servlet invokes subprograms for each piece of a complex file.
</P><P>
An <CODE>HttpServletResponse</CODE> must be adapted to a standard console. When a message is written to a console, it is actually written to the response's output stream.
</P><P>
Once a console program is running, it can invoke a subprogram. In turn, a subprogram can invoke sub-subprograms. And in turn, a sub-subprogram can invoke a sub-sub-subprogram.
</P><P>
When a subprogram is an implementation of <CODE>ConsoleProgram</CODE>, the subprogram's output is also written to the <CODE>HttpServletResponse</CODE>.
<H4>Servlet shell</H4>
It is possible to write a generic servlet shell. When invoked, the servlet shell offers a <a href="/view.php?topic=HTML&web=Main&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">HTML</a> <wikitopic HTML /wikitopic>form. You type the <a href="/view.php?topic=URI&web=Main&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">URI</a> <wikitopic URI /wikitopic>for any program on the form.
</P><P>
When you submit the URI, the generic servlet shell uses the <a href="/view.php?topic=SmartAPI&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">SmartAPI</a><wikitopic SmartAPI /wikitopic> to create a program. If it is a console program, output is piped back to your browser.
</P><P>
A console program is defined in such a way that it cannot wait for input from the keyboard (or terminal). A console program only writes messages to a console.
</P><P>
With a slight variation on the applet: scheme, it is possible for a servlet shell to create a page with an applet on the fly. Applet parameters are passed through the query-string part of an applet's uniform resource identifier. The query-string starts with question mark (?).
</P><P>
<EM>Why use a servlet shell?</EM>
</P><P>
A servlet shell enables you to run any server-side process. A pages of frequently used commands can greatly reduces your dependence on an ad-hoc, telnet-based session. A server side program can use all of the formatting options of <nolink>HTML, instead of telnet.
</P><P>
Regular maintenance of your website can be performed with point-and-click. Start or stop a service through your <nolink>HTTP service. Restart <a href="/view.php?topic=CVS&web=Main&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">CVS</a> <wikitopic CVS /wikitopic>with a click of a button.
</P><P>
Run any program on the server side. You can use many character-based programs with the run:os: scheme. Don't use native programs that require input from the keyboard!
</P><P>
The ps command, for example, happily outputs the list of processes running on the server to your web browser. You'll know for sure if a process is running. Once you have a process ID from ps, you can kill a service that's giving you trouble.
<H4>One thread</H4>
This model has very little overhead. When one program invokes another, the child program is running in the parent's thread. There is no need to isolate a child program to a new thread. With Java's limitations on object references, a child program cannot access the private data that belongs to its parent.
<H4>One process</H4>
Every program is run-able. The <CODE>Program</CODE> interface extends <CODE>java.lang.Runnable</CODE>. When a parent program wants a child to run in a separate thread, it passes the child program to a <CODE>java.lang.Thread</CODE> and starts the thread.
<H4>Multiple process</H4>
A <nolink>URI completely identifies a program as a digital resource. When a parent program wants a child to run in a separate process, it passes the program <nolink>URI to a standard method with a special implementation. The <CODE>exec()</CODE> method is already part of the <CODE>java.lang.Runtime</CODE> class. Here is its signature:
<PRE>
  public java.lang.Process exec( String command )
    throws java.io.IOException;
</PRE>
<H4>Multiple process virtual machine</H4>
A wide variety of valid <EM>commands</EM> are available. All commands are platform-specific. The parent process passes a command to its instance of <CODE>java.lang.Runtime</CODE>. An instance of <CODE>java.lang.Process</CODE> is returned. (Or, an <CODE>IOException</CODE> is thrown.)
</P><P>
Commands in a multiple process virtual machine are equal to a uniform resource locator (URI). A command is usually a program URI. Any instance of <CODE>java.lang.Runtime</CODE> can create a new <CODE>Process</CODE> and <CODE>ProcessContext</CODE>.
<OL> <LI> <CODE>exec()</CODE> creates a new classloader. The default classpath of a new classloader is inherited from the parent.
<LI> <CODE>exec()</CODE> creates a new instance of <CODE>SystemProcessContext</CODE> and uses its <CODE>parseArguments()</CODE> method to set its command (URI) and default result code. <CODE>pc.getClass().getClassLoader()</CODE> returns the new classloader.
<LI> <CODE>exec()</CODE> creates a new instance of <CODE>SystemProcess</CODE> and uses its <CODE>setProcessContext()</CODE> to install its process context. <CODE>p.getClass().getClassLoader()</CODE> returns the new classloader. <CODE>p.getProcessContext()</CODE> returns the new process context.
<LI> <CODE>exec()</CODE> starts the new <CODE>SystemProcess</CODE> thread.
<LI> Inside the multiple-process implementation of <CODE>Process</CODE>, a command (URI) is used to create a program. The program's <CODE>run()</CODE> method becomes the main thread of control. The process dies when all non-daemon threads have died.
<LI> For the benefit of the parent process, a new instance of <CODE>java.lang.Process</CODE> is returned from the <CODE>exec()</CODE> method. It is critical for <CODE>p.getClass().getClassLoader()</CODE> to return the parent's classloader for this object. The object returned to the parent only holds the process ID of the new system process. Using this process ID, it is possible to get standard in, standard out and standard error.
</OL> Through the interaction of <CODE>Runtime.exec()</CODE>, only a copy of a command string is passed to the multiple-process virtual machine. The multiple-process virtual machine creates a new classloader for each process. Each process holds a program. A program finds out more from the process through the standard <CODE>Runtime.getRuntime()</CODE>. With a new classloader for each process, the static instance of <CODE>Runtime</CODE> is unique to the process.
</P><P>
When a process dies, all of its objects and classes will be garbage collected. Classes loaded by its class loader will be garbage collected in the usual way.
<H4>Process list</H4>
The multiple-process virtual machine must maintain a list of active processes. The virtual machine must hang on to an object reference for a variety of reasons. The ps program must be able to list all active processes. The kill program must be able to kill a process. To protect garbage collection, a process must not be given a direct object reference to another process. Rather, a process is available through a process ID.
</P><P>
When a multiple-process virtual machine uses <a href="/view.php?topic=BytecodeNativeInterface&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">BytecodeNativeInterface</a><wikitopic BytecodeNativeInterface /wikitopic> (BCNI), <CODE>Runtime.exec()</CODE> is dispatched to <CODE>alt.LangBridge.exec()</CODE>. A call to <CODE>alt.LangBridge.exec()</CODE> is dispatched to a JVM-specific class. A JVM-specific class should use a native method to provide a system-wide process list.
<H4>About now</H4>
Bytecode for the ultimate virtual machine can be prototyped (written and tested) using mostly off-the-shelf software. Find an virtual machine with support for <a href="/view.php?topic=JavaNativeInterface&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">JavaNativeInterface</a><wikitopic JavaNativeInterface /wikitopic>. An off-the-shelf virtual machine can be hacked into a multiple-process virtual machine by extending <CODE>org.jos.bcni1a.Factory</CODE> and using native method(s).
</P><P>
When a custom <nolink>BCNI factory uses native methods, the native methods can manage system-wide JVM-specific classes, such as <CODE>SystemProcessList</CODE>.&lt;/P&gt;
&lt;P&gt;Each new process has its own instance of <CODE>Runtime</CODE> and <CODE>System</CODE>. Default system properties are copied from parent to child.
<H4>About system properties</H4>
In order to affect a change to classpath and other system properties, an original program <nolink>URI can be embedded in a command. This is another good reason to understand <a href="/view.php?topic=EmbeddedURIs&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">EmbeddedURIs</a><wikitopic EmbeddedURIs /wikitopic>. A system program might expect a <CODE>cmd</CODE> parameter to hold the original command and other parameters to overwrite classpath and modify system properties.
<PRE>
  public void example() {
    String n = "run:program:org.jos.gchii.find1a.Find";
    StringBuffer cmd = new StringBuffer();
    cmd.append( "run:program:system" );
    cmd.append( "?cmd=" + URITool.getTool().encode( n ) );
    cmd.append( "&amp;cp=" + URITool.getTool().encode( "/test" );
    cmd.append( "&amp;Duser=anonymous" );
    cmd.append( "&amp;Dpwd=anonymous" );
    Process p = Runtime.getRuntime().exec( cmd.toString() );
    p.waitFor();
    int rc = p.exitValue();
  }
</PRE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FProgramExec&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FProgramExec&PHPSESSID=f22f8d0933be84c0e48ae15bb150258c">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

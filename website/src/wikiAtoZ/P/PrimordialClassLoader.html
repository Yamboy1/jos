<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>PrimordialClassLoader.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="307507c73ff897e9e19444e889e155c2" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=307507c73ff897e9e19444e889e155c2">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=307507c73ff897e9e19444e889e155c2">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=307507c73ff897e9e19444e889e155c2">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=307507c73ff897e9e19444e889e155c2">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=307507c73ff897e9e19444e889e155c2">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//PrimordialClassLoader?PHPSESSID=307507c73ff897e9e19444e889e155c2">PrimordialClassLoader</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=307507c73ff897e9e19444e889e155c2">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=307507c73ff897e9e19444e889e155c2" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=307507c73ff897e9e19444e889e155c2"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/PrimordialClassLoader?PHPSESSID=307507c73ff897e9e19444e889e155c2">info</a> on or <a href="/edit/Imported/PrimordialClassLoader?PHPSESSID=307507c73ff897e9e19444e889e155c2">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FPrimordialClassLoader&PHPSESSID=307507c73ff897e9e19444e889e155c2">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FPrimordialClassLoader&PHPSESSID=307507c73ff897e9e19444e889e155c2">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=307507c73ff897e9e19444e889e155c2">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=307507c73ff897e9e19444e889e155c2">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=307507c73ff897e9e19444e889e155c2">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ProcessPages&PHPSESSID=307507c73ff897e9e19444e889e155c2">ProcessPages</a><wikitopic ProcessPages /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=307507c73ff897e9e19444e889e155c2">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (revised 1 June 2000).</EM></P>
<H4>Introduction</H4>
<P>A Java Virtual Machine (JVM) is just one of many bytecode interpreters. Why is everyone excited about Java? What makes it so different?</P>
<P>A <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>provides a fundamental improvement in class loading. A <STRONG>class loader</STRONG> is responsible for loading bytecodes for an interpreter. An interpreter, like a JVM, executes bytecodes after they are loaded.</P>
<P>Other interpreters make it difficult, if not impossible, to read byte codes from an alternative format or remote machine. They keep their class loader hidden. Their class loader is not extendable. Their interpreter becomes a dead end.</P>
<P>In contrast, it possible to create a custom class loader without rewriting a JVM. A custom class loader is a class and extends <CODE>java.lang.ClassLoader</CODE>.
<UL>
<LI><P>Use another protocol, like <nolink>HTTP and SQL, to download class files from another machine.</P>
<LI><P>Use custom bytecode file formats, like .zip, .jar and .cab.</P>
<LI><P>Run a network Agent and programs capable of moving from one machine to another.</P>
</UL>
<H4>Lowest level</H4>
<P>At the lowest levels of a Java Virtual Machine (JVM), there is a special class loader. It is often referred to as the <STRONG>primordial</STRONG> class loader. This loader is written in machine code, not bytecode. Functions for loading, verifying and executing bytecodes are a machine code part of each <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>implementation.</P>
<P>Classes loaded by the primordial class loader are called system classes. The primordial class loader implements a method equivalent to <CODE>findSystemClass()</CODE>.</P>
<TABLE WIDTH="100%" BGCOLOR="#EFEFEF">
<TR>
<TD>
<PRE>
public interface SystemClassFinder {
  public Class findSystemClass( String name );
}
</PRE>
</TD>
</TR>
</TABLE>
<P>On the one hand, we have Java applications. Inside Sun's <a href="/view.php?topic=JDK&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JDK</a> <wikitopic JDK /wikitopic>and <a href="/view.php?topic=JavaSoft&PHPSESSID=307507c73ff897e9e19444e889e155c2">JavaSoft</a><wikitopic JavaSoft /wikitopic>'s JRE, the primordial class loader loads bytecodes only from local OS files. It recognizes the <CODE>CLASSPATH</CODE>. It loads bytecodes from .class files and archives (.zip and .jar).</P>
<P>On the other hand, we have Java applets. Inside a browser's JVM, a custom class loader loads both local and remote bytecodes. It loads remote bytecodes using a URL. It loads local bytecodes using the primodial class loader. A browser recognizes both <CODE>CLASSPATH</CODE> and <CODE>CODEBASE</CODE>. It loads .class files and archives (.zip, .jar and sometimes .cab).</P>
<H4>About static</H4>
<P>A system class is based on <CODE>CLASSPATH</CODE>. <CODE>CLASSPATH</CODE> cannot be changed during the lifetime of a primordial class loader. In classic design, system classes are loaded once and only once during the lifetime of a <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>because it has exactly one primordial class loader. Because of the following things, a static variable is really static for system classes.</P>
<UL>
<LI><P>Static varibles are initialized once and only once during the lifetime of a primordial class loader.</P>
</UL>
<P>A non-system class is based on <CODE>CODEBASE</CODE> or a custom class loader. <CODE>CODEBASE</CODE> changes from one <a href="/view.php?topic=HTML&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">HTML</a> <wikitopic HTML /wikitopic>page to another. A custom class loader can reused many times. Because of these things, a static variable really isn't static for non-system classes.
<UL>
<LI>Static variables are initialized <EM>less often</EM> than other variables. It may be once per restart of an applet. It may be once per instance of a custom class loader.
</UL>
<P>For more information on static semantics, see also <a href="/view.php?topic=WhyJarsAreBad&PHPSESSID=307507c73ff897e9e19444e889e155c2">WhyJarsAreBad</a><wikitopic WhyJarsAreBad /wikitopic>.</P>
<P>In <a href="/view.php?topic=JavaNativeInterface&PHPSESSID=307507c73ff897e9e19444e889e155c2">JavaNativeInterface</a><wikitopic JavaNativeInterface /wikitopic> (JNI) design, <CODE>CLASSPATH</CODE> cannot be changed during the lifetime of a primordial class loader. Like the classic design, system classes are loaded once and only once during the lifetime of each primordial class loader. Each <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>has exactly one primordial class loader even with multiple JVMs in a single machine code process.</P>
<P>In <a href="/view.php?topic=MPCL&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">MPCL</a> <wikitopic MPCL /wikitopic>design, <CODE>CLASSPATH</CODE> cannot be changed during the lifetime of a primordial class loader. Like classic and <a href="/view.php?topic=JNI&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JNI</a> <wikitopic JNI /wikitopic>design, system classes are loaded one and only one during the lifetime of each primordial class loader. Unlike the classic or <a href="/view.php?topic=JNI&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JNI</a> <wikitopic JNI /wikitopic>design, system classes are loaded one or more times during the lifetime of a virtual machine because a virtual machine may have more than one primordial class loader.</P>
<H4>Not a class</H4>
<P>Unfortunately, the primordial class loader isn't a real Java class. It isn't derived from <CODE>java.lang.ClassLoader</CODE>. It cannot be used by Java applications directly. There is no <a href="/view.php?topic=SystemClassFinder&PHPSESSID=307507c73ff897e9e19444e889e155c2">SystemClassFinder</a><wikitopic SystemClassFinder /wikitopic> interface.</P>
<P>On the other hand, you can create a substitute for the primordial class loader, like this:</P>
<TABLE WIDTH="100%" BGCOLOR="#EFEFEF">
<TR>
<TD>
<PRE>
import java.util.Hashtable;

public class PrimordialClassLoader
	 extends ClassLoader {
  public PrimordialClassLoader() {
	 super();
  }

  public Class findClass( String name )
		throws ClassNotFoundException {
	 return loadClass( name, true );
  }

  protected Class
		loadClass( String name, boolean resolve )
		throws ClassNotFoundException {
	 Object o = cache.get( name );
	 if ( o != null ) {
		if ( o instanceof Class ) {
		  return (Class) o;
		}
	 }

	 println( "loading '" + name + "' class" );
	 Class c = findSystemClass( name );
	 cache.put( name, c );
	 if ( resolve ) {
		resolveClass( c );
	 }
	 return c;
  }

  protected void println( String v ) {
	 System.out.println( v );
  }

  private Hashtable cache = new Hashtable();
}
</PRE>
</TD>
</TR>
</TABLE>
<P>See how it runs with a test class, like this:</P>
<TABLE WIDTH="100%" BGCOLOR="#EFEFEF">
<TR>
<TD>
<PRE>
public class PrimodialClassLoader_Test {
  public static void main( String[] args ) {
	 PrimordialClassLoader_Test app =
		  new PrimordialClassLoader_Test();
	 app.run();
  }

  public PrimordialClassLoader_Test() {
  }

  public void run() {
	 String className = "java.lang.String";

	 PrimordialClassLoader loader =
		  new PrimordialClassLoader();
	 Class c;
	 try {
		c = loader.findClass( className );
	 }
	 catch( ClassNotFoundException e ) {
		println( "ClassNotFoundException" );
		println( e.getMessage() );
		return;
	 }

	 try {
		Object o = c.newInstance();
	 }
	 catch( InstantiationException e ) {
		println( "InstantiationException" );
		println( e.getMessage() );
		return;
	 }
	 catch( IllegalAccessException e ) {
		println( "IllegalAccessException" );
		println( e.getMessage() );
		return;
	 }
  }
}
</PRE>
</TD>
</TR>
</TABLE>
<H4>One JVM, many processes</H4>
<P>When there is one and only one JVM, it means that many custom processes can share a single copy of bytecodes for all system classes. For more information on a multiple process JVM, see also <a href="/view.php?topic=WhyMultiProcessJVM&PHPSESSID=307507c73ff897e9e19444e889e155c2">WhyMultiProcessJVM</a><wikitopic WhyMultiProcessJVM /wikitopic>.
<P>The <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>is supposed to insist that bytecodes for all system classes are loaded once. Unfortunately, there are problems and advantages in the design of <CODE>java.lang.ClassLoader</CODE>. A custom class loader must <EM>volunteer</EM> to load a class once and only once. Of course, leaving it up to a custom class is less than optimal.</P>
<P><EM>Note:</EM> From what little testing I have been able to do, <CODE>Class.forName()</CODE> always uses the primordial class loader and not the <EM>custom</EM>ClassLoader of the requestor. <CODE>forName()</CODE> is a static method of a system class and doesn't depend on the requestor.</P>
<H4>One primordial class loader, many JVMs</H4>
<P>A vm-wide bytecode cache would solve a lot of problems with existing JVMs. All of the class files available through <CODE>CLASSPATH</CODE> could be loaded once and only once, shared by many JVMs, even with each <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>running in its own machine code process.</P>
<TABLE WIDTH="100%" BORDER="1">
<TR>
<TD>
<TABLE WIDTH="100%" BORDER="1">
<TR>
<TD>JVM</TD>
<TD>JVM</TD>
<TD>..</TD>
<TD>JVM</TD>
</TR>
</TABLE>
<UL>
<LI>one OS kernel
<LI>one bytecode cache
</UL>
</TD>
</TR>
</TABLE>
<P>A bytecode cache provides class files for a primordial class loader. A single bytecode cache could have addition bytecode providers registered with an <CODE>addBytecodeProvider()</CODE> method. It could, for example, load all classes in a package, load and validate bytecode for a class once and only once, provide a direct method to cache a class file from all registered class loaders.</P>
<P>A bytecode cache could, for example, expand and alter the <CODE>CODEBASE</CODE> during the life of the JVM. It could add another directory to its bytecode provider list with an <CODE>addBytecodeDirectory()</CODE> method.</P>
<P>A bytecode cache could, for example, pre-load selected packages. Part of tuning an system would be deciding which packages are pre-loaded at start-up.</P>
<P>Like the relationship between <a href="/view.php?topic=JDBC&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JDBC</a> <wikitopic JDBC /wikitopic>drivers and <a href="/view.php?topic=DriverManager&PHPSESSID=307507c73ff897e9e19444e889e155c2">DriverManager</a><wikitopic DriverManager /wikitopic>, a class loader manager could search all class loaders to find an existing class. The order of the search becomes important. The primordial class loader would always be first. And then, it would be mandatory on the part of class loaders to load system classes and cache classes properly.</P>
<H4>Why not a class?</H4>
<P>It has been explained away that the primordial class loader can't be a real class. It is a recursive dependency. It would have to load itself, right?</P>
<P>I don't think so, and here's why.</P>
<P>Before the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>runs the main() method of a custom application, it has a lot of things to do. It is all part of the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>start-up sequence. There is an opportunity, just before calling the main() method, for the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>to install a <CODE>ClassLoaderManager</CODE> that implements the <CODE>SystemClassFinder</CODE> interface.</P>
<P>When I started thinking about <a href="/view.php?topic=JOS&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JOS</a> <wikitopic JOS /wikitopic>kernel, I think it would be splendid for kernel to provide each copy of the <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>a handle to a share <CODE>ClassLoaderManager</CODE>.</P>
<UL>
<LI>An interface comes to the rescue. <CODE>java.lang.SystemClassFinder</CODE> could have been a simple interface, <EM>and should have been</EM>. The interface declares that this class implements the <CODE>findSystemClass</CODE> method.
<LI>Each <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>running in its own process could create an instance of some class that implements <CODE>SystemClassFinder</CODE>. Each <a href="/view.php?topic=JVM&web=Imported&PHPSESSID=307507c73ff897e9e19444e889e155c2">JVM</a> <wikitopic JVM /wikitopic>installs one copy of this class.
<LI>When building <EM>custom</EM>ClassLoaders, a programmer would extend <CODE>java.lang.ClassLoader</CODE>.
<LI>When building <EM>custom</EM>SystemClassLoaders, a programmer would extend <CODE>java.lang.SystemClassLoader</CODE>. In the constructor of a system class loader, it would automatically register itself with the <CODE>SystemClassManager</CODE>.
</UL>
<P>New method must be added to the <CODE>java.lang.System</CODE> class:</P>
<TABLE WIDTH="100%" BGCOLOR="#EFEFEF">
<TR>
<TD>
<PRE>
public class System {
:
  public native SystemClassManager getSystemClassManager();
  public native SystemClassFinder getSystemClassFinder();
:
}
</PRE>
</TD>
</TR>
</TABLE>
</TD>
</TR>
</TABLE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FPrimordialClassLoader&PHPSESSID=307507c73ff897e9e19444e889e155c2">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FPrimordialClassLoader&PHPSESSID=307507c73ff897e9e19444e889e155c2">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>PureReflectionForC.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="b91c03da37846d0c579828e5f3164e46" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//PureReflectionForC?PHPSESSID=b91c03da37846d0c579828e5f3164e46">PureReflectionForC</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=b91c03da37846d0c579828e5f3164e46" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=b91c03da37846d0c579828e5f3164e46"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/PureReflectionForC?PHPSESSID=b91c03da37846d0c579828e5f3164e46">info</a> on or <a href="/edit/Imported/PureReflectionForC?PHPSESSID=b91c03da37846d0c579828e5f3164e46">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FPureReflectionForC&PHPSESSID=b91c03da37846d0c579828e5f3164e46">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FPureReflectionForC&PHPSESSID=b91c03da37846d0c579828e5f3164e46">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=b91c03da37846d0c579828e5f3164e46">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=BytecodePages&PHPSESSID=b91c03da37846d0c579828e5f3164e46">BytecodePages</a><wikitopic BytecodePages /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=b91c03da37846d0c579828e5f3164e46">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (15 November 2000).</EM></P>
<H4>Introduction</H4>
<P><EM>Pure Reflection for C</EM> is nearly complete. It puts a C-style <a href="/view.php?topic=API&web=Imported&PHPSESSID=b91c03da37846d0c579828e5f3164e46">API</a> <wikitopic API /wikitopic>in front of <EM>Pure Reflection for C++</EM></P>
<H4>Puzzle</H4>
<P>There are two distinct problems to be solved with <EM>Pure Reflection for C</EM>. The first is the management of a linked list of open bytecode. The second is the mapping of C-style functions to C++ objects.</P>
<H4>Linked list</H4>
<P>This <nolink>API is part of a bytecode cache. Bytecode goes through a life-cycle. Like a file, bytecode is opened, used and then closed. The cache must contain the bytecode while it is open.</P>
<P>The <CODE>rc<EM>openBytecode()</CODE> function adds a node to a cache, currently implemented as a singly linked list. The <CODE>rc</EM>closeBytecode()</CODE> function removes a node from the linked list. The last handle field is hidden inside the C library. It is incremented exclusively by the <CODE>rc_openBytecode()</CODE> function.</P>
<P>The C-style <nolink>API returns a handle to the bytecode. The bytecode object itself is never returned. It is hidden by the <nolink>API.</P>
<P>The handle is something like the following:</P>
<PRE>
typedef struct {
  long data;
} BCHANDLE;
</PRE>
<P>The <CODE>rc_openBytecode()</CODE> function opens bytecode and returns an handle.</P>
<PRE>
BCHANDLE rc_openBytecode( const void *v, size_t size );
</PRE>
<P>Like <CODE>rc<EM>openBytecode()</CODE>, the <CODE>rc</EM>openClassFile()</CODE> function opens bytecode and returns a handle. Unlike <CODE>rc_openBytecode()</CODE>, it makes a copy of the given buffer.</P>
<PRE>
BCHANDLE rc_openClassFile( const char *n );
BCHANDLE rc_openClassFile( const void *v, size_t size );
</PRE>
<P>The remaining functions of this <nolink>API require the bytecode handle as a parameter.</P>
<H4>Linked list</H4>
<P>Open bytecode is stored by this C library as a linked list. While the <CODE>BytecodeItem</CODE> class does not free its buffer because it is allocated elsewhere, the <CODE>ClassFileItem</CODE> class makes a copy of the given buffer and frees it later.</P>
<PRE>
class BytecodeItem {
  public:
	 BytecodeItem( const void *v, size_t s ) {
		bc = rc_createBytecode( v, s );
	 }
	 virtual ~BytecodeItem() {
		delete bc;
	 }
	 rc_Bytecode *getBC() const {
		return bc;
	 }

  private:
	 rc_Bytecode *bc;

};
</PRE>
<H4>Node</H4>
<P>Nodes are linked together. Each node contains a unique handle.</P>
<PRE>
class Node {
  public:
	 Node( BCHANDLE h, BytecodeItem *v ) {
		handle = h;
		bi = v;
		pnext = NULL;
	 }
	 virtual ~Node() {
		delete bi;
	 }
	 bool isHandle( BCHANDLE h ) {
		return ( handle == h );
	 }
	 rc_Bytecode *getBC() const {
		return bi-&gt;getBC();
	 }
	 Node *getNext() const {
		return pnext;
	 }
	 void setNext( Node *v ) {
		pnext = v;
	 }
  protected:
  private:
	 BCHANDLE handle;
	 BytecodeItem *bi;

	 Node pnext;
};
</PRE>
<P>The head of the linked list is a static field in the implementation of the C-style <nolink>API.</P>
<PRE>
static Node *ptop = NULL;
</PRE>
<H4>Mapping</H4>
<P>Each C function must be mapped to its corresponding method. The <CODE>rc_Bytecode</CODE> class has many methods.</P>
<P>The <CODE>CharBuffer</CODE> class in C++ cannot be exposed in the C-style <nolink>API. Therefore, the methods of <CODE>rc_Bytecode</CODE> that return a <CODE>CharBuffer</CODE> must return an ASCIIz string, or <CODE>const char *</CODE>. The following method does a safe convertion from C++ to C.</P>
<PRE>
static CharBuffer cbuf;

const char *getCbuf( const CharBuffer &amp;other ) {
  cbuf = other;
  return cbuf.getData();
}
</PRE>
<P>First a C function must find the corresponding instance of <CODE>rc_Bytecode</CODE> based on the given handle.</P>
<PRE>
rc_Bytecode *getBytecode( BCHANDLE h ) {
  Node pcurr = ptop;
  for (;;) {
	 if ( pcurr == NULL ) {
		return NULL;
	 }

	 if ( pcurr-&gt;isHandle( h ) ) {
		return pcurr-&gt;getBC();
	 }

	 pcurr = pcurr-&gt;getNext();
  }
}
</PRE>
<P>Here is a simple example.</P>
<PRE>
const char *rc_getInterfaceName( BCHANDLE h, unsigned short index ) {
  rc_Bytecode *bc = getBytecode( h );
  if ( bc == NULL ) {
	 return NULL;
  }

  return getCbuf( bc-&gt;getInterfaceName( index ) );
}
</PRE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FPureReflectionForC&PHPSESSID=b91c03da37846d0c579828e5f3164e46">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FPureReflectionForC&PHPSESSID=b91c03da37846d0c579828e5f3164e46">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

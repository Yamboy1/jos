<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>ProcessContextAndInit.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="ab860bce00df1cdc619d82cf3568e7f7" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//ProcessContextAndInit?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">ProcessContextAndInit</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/ProcessContextAndInit?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">info</a> on or <a href="/edit/Imported/ProcessContextAndInit?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FProcessContextAndInit&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FProcessContextAndInit&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ProcessAndProcessContext&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">ProcessAndProcessContext</a><wikitopic ProcessAndProcessContext /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (10 March 2000).</EM></P>
<H4>Introduction</H4>
<P>The start-up sequence for <nolink>ERIC is something like this:</P>
<OL>
<LI><P><STRONG>pre-Virtual Machine phase</STRONG></P>
<P>This part is machine code. Parameters must be gathered and calculated before creating a virtual machine. Parameters include <EM>classpath</EM>, <EM>packagepath</EM>, <EM>shell</EM> and <EM>location</EM>.</P>
<LI><P><STRONG>Virtual machine phase</STRONG></P>
<P>ERIC searches for a shared library that implements a virtual machine. The exact name of the shared library is not known at compile-time. A native mechanism is used to load the shared library dynamically. The <a href="/view.php?topic=JavaNativeInterface&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">JavaNativeInterface</a><wikitopic JavaNativeInterface /wikitopic>, or JNI, is used to create a virtual machine. The <EM>classpath</EM> parameter is passed to the new virtual machine.</P>
<LI><P><STRONG>Bootstrap phase</STRONG></P>
<P>JNI is used again to create an instance of the <CODE>RunEricApplication</CODE> class. The <EM>packagepath</EM>, <EM>shell</EM> and <EM>location</EM> parameters are passed to this class through its static main() method.</P>
<LI><P><STRONG>Classloader phase</STRONG></P>
<P><CODE>RunEricApplication</CODE> passes the <EM>packagepath</EM> parameter to a custom class loader. An instance of <CODE>RunEricApplication</CODE> is still a system class.</P>
<LI><P><STRONG>Shell phase</STRONG></P>
<P>Then, <CODE>RunEricApplication</CODE> uses the <EM>shell</EM> parameter to create a shell. It uses a custom class loader to dynamically load the shell's class. A shell is typically implements the <CODE>Shell</CODE> interface.</P>
<LI><P><STRONG>Location phase</STRONG></P>
<P><CODE>RunEricApplication</CODE> passes the <EM>location</EM> parameter to the shell.</P>
</UL>
<H4>About <nolink>JOS</H4>
<P>The start-up sequence for <a href="/view.php?topic=ERIC&web=Imported&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">ERIC</a> <wikitopic ERIC /wikitopic>is a prototype for <nolink>JOS. Like ERIC, <nolink>JOS must create a class loader before loading either a system or user process.</P>
<PRE>
  public void init() {
	 for (;;) {
		try {
		  startSystemProcess();
		  break;
		}
		catch( RestartException e ) {
		}
	 }
  }
</PRE>
<P>When the system process throws a <CODE>RestartException</CODE>, <nolink>JOS will restart the start-up sequence without rebooting the kernel. The configuration will be reprocessed.</P>
<P>To change configuration, modify the system-wide registry and call a system method, called <CODE>restart()</CODE>. The request for a restart is passed to the system process. Only the system process can actually throw a system-wide restart exception. In other words, you can modify your configuration <STRONG>without rebooting the kernel.</STRONG></P>
<P>To change the behavior of your system process, recompile classes used by your system process and then call <CODE>restart()</CODE>. In other words, you can recompile bytecode for a device driver and restart your computer <STRONG>without rebooting the kernel.</STRONG></P>
<P>To upgrade, install packages used by your system process and then call <CODE>restart()</CODE>. In other words, you can upgrade your operating system <STRONG>without rebooting the kernel.</STRONG></P>
<P>Upon return from the <CODE>startSystemProcess()</CODE> method, there is no longer any reference to the custom class loader used to load classes for your system process. There are no user processes, no user threads, no device drivers, etc. Even the intern'd bytecode does not survive a restart.</P>
<H4>About <CODE>init</CODE></H4>
<P>Ultimately, <CODE>init</CODE> should be the system process. It should be loaded within <CODE>startSystemProcess</CODE>. It should not be loaded by machine code. A step must be inserted into the start-up sequence so that <CODE>init</CODE> has all of the priviledges and responsibilities of an independent process.</P>
<P>A system process is different than a user process. A system process has special priviledges. <CODE>init</CODE> should be the only system process. For example, it is appropriate for a system process to read and write system memory directly. Such access by a user process would be a security breach.</P>
<P>Low-level device drivers are threads loaded by the system process. Because they are part of the system process' thread group, they operate with system priviledges, too.</P>
<P>The system process creates all other processes.</P>
<H4>User process</H4>
<P>When a thread calls the <CODE>exec()</CODE> method of <CODE>java.lang.Runtime</CODE>, this method creates a user process. A user process has limits. It must use high-level devices to communicate with peripherals.</P>
<P>For each process-wide class, a process context has a corresponding property.</P>
<PRE>
public class ProcessContext {
  public Class getThreadGroupClass() {
	 return cThreadGroup;
  }
  public Class getRuntimeClass() {
	 return cRuntime;
  }
  public Class getSystemClass() {
	 return cSystem;
  }
  public Class getSecurityManagerClass() {
	 return cSecurityManager;
  }
  private ClassLoader loader;
  private Class cThreadGroup;
  private Class cRuntime;
  private Class cSystem;
  private Class cSecurityManager;
}
</PRE>
<H4>Custom class loader</H4>
<P>The custom class loader must be used to create these other classes.</P>
<PRE>
	 :
	 ClassLoader loader = new CustomClassLoader();
	 :
</PRE>
<H4>Process context</H4>
<P>The process context must be added to a linked list that belongs to the system process.</P>
<PRE>
	 :
	 String cn = "org.jos.demo.ProcessContext";
	 Class c = loader.findClass( cn );
	 Object o = c.newInstance();
	 ProcessList.addProcess( o );
	 Runnable r = (Runnable) o;
	 r.run();
	 :
</PRE>
<H4>Within <CODE>run()</CODE></H4>
<P>Run the process context to create process-wide classes.</P>
<PRE>
	 public void run() {
		String cn;

		cn = "java.lang.ThreadGroup";
		cThreadGroup = loader.findClass( cn );

		cn = "java.lang.Runtime;
		cRuntime = loader.findClass( cn );

		cn = "java.lang.System";
		cSystem = loader.findClass( cn );

		cn = "java.lang.SecurityManager";
		cSecurityManager = loader.findClass( cn );

		cn = "init";
		Runnable r = loader.findClass( cn ).newInstance();

		ThreadGroup g = (ThreadGroup) cThreadGroup.newInstance();
		Thread t = new Thread( g, r );
		t.start();
	 }
</PRE>
<P>The thread that creates the custom class loader and process context cannot be the same thread in which <CODE>init</CODE> runs.</P>
<H4>String</H4>
<P>A multiple process virtual machine has the potential for keeping only one copy of a string used by hundreds of different programs. Strings are unique. They are read-only. When a string is intern'd, it is a system-wide intern of all read-only strings. When two processes intern the same string, both get a reference to the same object.</P>
<P>In an off-the-shelf virtual machine, the class loader property for <CODE>java.lang.Runtime</CODE> is <CODE>null</CODE>. This indicates that it has been loaded by the primordial class loader.</P>
<P>In a multiple process virtual machine, the class loader property for <CODE>java.lang.Runtime</CODE> is not <CODE>null</CODE>. This indicates that it has been loaded by a custom class loader.</P>
<PRE>
  public void example() {
	 System.out.println( "Hello, World!" );
  }
</PRE>
<P>When <CODE>System</CODE> is a process-wide class, its in, out and err properties are independent of all other processes. Plus, its getProperties() method returns an independent instance of <CODE>java.util.Properties</CODE>.</P>
<H4>Reject?</H4>
<P><CODE>java.lang.System</CODE> has been compiled to a class file called "/decaf/classes/java/lang/System.class". The in:blob: scheme loads a file into a byte array. The following code might be rejected unconditionally in an off-the-shelf virtual machine:</P>
<PRE>
  public void example() {
	 String cf = "/decaf/classes/java/lang/System.class";
	 URI uri = new URI( "in:blob:file:" + cp + cf )
	 byte[] buf = (byte[]) uri.getObject();
	 Class c = loader.defineClass( buf );
  }
</PRE>
<P>But, a multiple process virtual machine must re-define a process-wide class under a special circumstance. A virtual machine should allow one and only one re-definition of a process-wide class for each process. While the system process is building a process context, a virtual machine must allow a re-definition of a process-wide class.</P>
<P>Removing <CODE>java/lang/ThreadGroup.class</CODE>, <CODE>java/lang/Runtime.class</CODE>, <CODE>java/lang/System.class</CODE> and <CODE>java/lang/SecurityManager.class</CODE> from rt.jar (or classes.zip) will force a custom class loader to load these classes.</P><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FProcessContextAndInit&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FProcessContextAndInit&PHPSESSID=ab860bce00df1cdc619d82cf3568e7f7">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>

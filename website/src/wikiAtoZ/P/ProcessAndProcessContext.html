<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">
<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
    <TITLE>ProcessAndProcessContext.Imported @ jos.sf.net</TITLE>
  </HEAD>

<BODY BGCOLOR="#FFFFFF">

<!-- The FORM encloses the entire header, because it renders better that way. !-->
<FORM ACTION="/jump.php"><input type="hidden" name="PHPSESSID" value="30c4f1a625635a7e7b9830ba5b50c812" />

<!-- The JOS logo. !-->
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR VALIGN="TOP" ALIGN="LEFT">
	<TD><A HREF="http://cjos.sourceforge.net/archive/"><IMG 
		VSPACE="0" HSPACE="0" ALIGN="MIDDLE" BORDER="0"
		SRC="http://cjos.sourceforge.net/archive/media/jos_logo_mini.gif"></A></TD>
	<!-- The tab table. !-->
	<TD WIDTH="100%" ALIGN="RIGHT" BGCOLOR="#FFFFFF" VALIGN="BOTTOM"> 
		<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%" ALIGN="RIGHT">
			<TR VALIGN="MIDDLE" ALIGN="LEFT">

<TD BGCOLOR="White" WIDTH="60%">&nbsp;</TD>
<TD BGCOLOR="#FFFFCC"><A HREF="http://cjos.sourceforge.net/archive/">Home</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/info/">Info</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFFFCC" ALIGN="CENTER"><A HREF="http://cjos.sourceforge.net/archive/dev/">DevZone</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
<TD WIDTH="10%" BGCOLOR="#FFCC66" ALIGN="CENTER"><A
HREF="http://jos.sourceforge.net/">Wiki</A></TD>
<TD BGCOLOR="White">&nbsp;</TD>
			</TR>
			<TR>
				<TD BGCOLOR="#FFCC66" ALIGN="RIGHT" COLSPAN="9">
					<A HREF="/view/Users/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">UsersWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Main/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">MainWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Info/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">InfoWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/DevZone/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">DevZoneWeb</A>
					&nbsp;|&nbsp;
					<A HREF="/view/Support/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">SupportWeb</A>
				</TD>
			</TR>
		</TABLE>
	</TD>		
</TR>
<!-- The WikiHeader. !-->
<TR><TD COLSPAN="2">
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
<TR>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="CENTER">
		<B>[&nbsp;<a href="/info//ProcessAndProcessContext?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">ProcessAndProcessContext</a>&nbsp;]</B>
	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="CENTER">
		<B>[ not logged in ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="CENTER">
		<B>[ Web: <a href="/view/Imported/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">Imported</a> ]</B>	</TD>
	<TD WIDTH="25%" ALIGN="CENTER" BGCOLOR="#FFCC66" VALIGN="CENTER">
		goto:&nbsp;<INPUT TYPE="TEXT" SIZE="10" NAME="topic"><!--<INPUT TYPE="IMAGE" SRC="/media/go.gif?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812" BORDER="0" VALUE="topic" ALT="goto">!-->&nbsp;<a href="/search.php?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812"><FONT SIZE="-1">options</FONT></a>
	</TD>
</TR>
</TABLE>

<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="3" WIDTH="100%">
	<TR>
	<TD ALIGN="CENTER" BGCOLOR="#FFFFCC" VALIGN="TOP">
		[&nbsp;get <a href="/info/Imported/ProcessAndProcessContext?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">info</a> on or <a href="/edit/Imported/ProcessAndProcessContext?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">edit</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFEE88" VALIGN="TOP">
		[&nbsp;<a href="/user.php?op=login&redirect=%2Fview%2F%2FProcessAndProcessContext&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FProcessAndProcessContext&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">new&nbsp;user</a>&nbsp;]	</TD>
	<TD ALIGN="CENTER" BGCOLOR="#FFDD77" VALIGN="TOP">
		[&nbsp;list of <a href="/topics/Imported/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">topics</a>, <a href="/hubsnodes/Imported/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">hubs&nbsp;&amp;&nbsp;nodes</a>, or <a href="/changes/Imported/?PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">recent&nbsp;changes</a>&nbsp;]	</TD>
	</TR>
</TABLE>

<!-- From CommonHeader !-->
</TR></TD>
</TABLE>
</FORM>

<!-- start BODY page !-->
<P>
<FONT SIZE="-1"><a href="/view.php?topic=ArchitectureGroup&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">ArchitectureGroup</a><wikitopic ArchitectureGroup /wikitopic></FONT>
<HR SIZE="1" NOSHADOW>
<P><EM>Article contributed by <a href="/view.php?topic=GilbertHerschberger&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">GilbertHerschberger</a><wikitopic GilbertHerschberger /wikitopic> (9 March 2000).</EM></P>
<H4>Introduction</H4>
<P>I race through this cycle every three or four minutes. This happens fifteen to twenty times an hour. At this rate, even a slightly more efficient process could save me hundreds of hours each year.</P>
<OL>
<LI><P><STRONG>Write code.</STRONG></P>
<P>Typically, I write non-visual components. I write with more than one programming language. Don't you?</P>
<LI><P><STRONG>Compile code</STRONG></P>
<P>Typically, I use an <EM>integrated development environment</EM> (or IDE), so that I can easily compile the code I write. I use more than one IDE. Don't you? I use, from most frequent to least, Borland C++, Borland JBuilder, Corel Paradox for Windows, and Borland Delphi.</P>
<LI><P><STRONG>Debug code</STRONG></P>
<P>I spend very little time in a traditional single-step debugger. I don't have time for that. (I have never used <CODE>jdb</CODE>, the Java debugging tool.)</P>
<LI><P><STRONG>Run code</STRONG></P>
<P>Within a few seconds of writing code and compiling it, I run it. Running my own code is where I probably spend most of my time. I run a program to see if it "works" for me. My ultra-conservative corporate customsers run a program to see if it "works" for them. You might run a program just to see if it "works", wouldn't you?</P>
<LI><P><STRONG>Go to step 1.</STRONG></P>
</OL>
<H4>Problem</H4>
<P>My performance as a programmer depends on how fast I can race through my write, compile, debug and run cycle. With everything but Java, I can go through this cycle very quickly. When I invoke a program, the <EM>latest</EM> version will run. It is guaranteed.</P>
<P><EM>What about Java?</EM></P>
<P>With Java, I have to wait. I don't like waiting.</P>
<P>With Java, I have to think about it. Am I running this program for the first time? Or, did I run this program before? Classes are cached. A class is usually created once and only once during the life-cycle of a virtual machine.</P>
<P>A class might not be reloaded automatically. By default, a class cannot detect when its class file has changed (as in "re-compiled").</P>
<P>A virtual machine must preserve static fields for as long as possible. Static fields are closely associated with an instance of a class. It would be inappropriate for a virtual machine to reload a class file periodically.</P>
<P>When I run an off-the-shelf virtual machine, it closely associates a virtual machine with an application program. It upholds the design rule of <EM>one process equals one virtual machine</EM> at the heart of the <a href="/view.php?topic=JavaVirtualMachineSpecification&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">JavaVirtualMachineSpecification</a><wikitopic JavaVirtualMachineSpecification /wikitopic>.</P>
<H4>Custom class loader</H4>
<P>A custom class loader takes us beyond the problem. It takes us beyond the typical behavior of a virtual machine. A virtual machine is expected to enforce the following behavior:</P>
<UL>
<LI><P><EM>When a class loader is garbage-collected, all classes loaded by the class loader have already been garbage-collected.</EM></P>
<P>For as long as an instance of class owns a reference to the class loader, the class loader cannot be garbage-collected.</P>
<LI><P><EM>When a class is garbage-collected, all instances of the class have already been garbage-collected.</EM></P>
<P>For as long as an instance of a class has a reference to the class, the class cannot be garbage-collected.</P>
</UL>
<H4>Process</H4>
<P>A process has-a <CODE>ThreadGroup</CODE> and custom <CODE>ClassLoader</CODE>. Because a process has a custom class loader, all of the classes used by a process will reference a custom class loader. When the process dies, all of its objects are garbage-collected. On the first pass, regular objects are garbage-collected. This removes all references to custom classes. On the second pass, custom classes are garbage-collected. This removes all references to a custom class loader. On the third pass, a custom class loader is garbage collected.</P>
<P><EM>How do I re-run my custom application without re-starting my virtual machine?</EM></P>
<P>I can re-run my custom application without starting my virtual machine. I must launch my custom application as a "process", with its own thread group and custom class loader.</P>
<P>To guarantee that my new application runs the latest version of all its class files, a new process <EM>must not</EM> inherit the classes that have already been loaded. A new process is suitably independent from previous applications.</P>
<P>As bytecode is loaded, it is compared with bytecode that has already been loaded. If it exactly matches existing bytecode, only the original is retained; the other is garbage collected. An optimized implementation of <CODE>ClassLoader</CODE> must intern the bytecode.</P>
<P>This shortens my development cycle. I can re-run my custom program without restarting my virtual machine. Here are some of the benefits:</P>
<UL>
<LI><P>a virtual machine loads once;</P>
<LI><P><CODE>java.*</CODE> packages are loaded once;</P>
<LI><P><CODE>java.net</CODE> loads the TCP/IP stack once;</P>
<LI><P>a browser/desktop/shell loads once; and</P>
<LI><P>bytecode takes less space.</P>
</UL>
<H4>Reboot</H4>
<P>Restarting a virtual machine is equivalent to rebooting your computer. While it is possible to reboot your computer after you compile a program, that would be excessive by today's standards. Restarting a virtual machine for the sake of reloading a few class files is just as excessive.</P>
<P><EM>Why should I restart my virtual machine when I don't have to?</EM></P>
<P>A process must be able to load the latest version of a class file without restarting the virtual machine and without running out of RAM. For the ultimate <nolink>JOS, it would be excessive to reboot your computer after installing new class files. A virtual machine is machine code. It hasn't changed. There is no need to reload it. And yet, we want a model where the latest version of a class file is used by a new application.</P>
<H4>What is a process?</H4>
<P>From one point of view, a process is simply an object that is run-able. (It should implement the <CODE>Runnable</CODE> interface.) But, it is more than that.</P>
<P>A process is special. Unlike other objects that are runnable, a process has-a process context. A process runs with a process context. A process context is what makes a process.</P>
<P><EM>How do I create a process?</EM></P>
<P>The following step-by-step procedure will create a "process".</P>
<UL>
<LI><P><STRONG>Select a class name.</STRONG></P>
<P>A candidate class name is any instance of <CODE>java.lang.String</CODE>.</P>
<LI><P><STRONG>Create a custom class loader.</STRONG></P>
<P>The custom class loader will be used exclusively by the new process. This class loader inherits the classpath from its parent process. The primary domain, or <EM>system process</EM>, must create this custom class loader. The primary domain class loader must be returned by <CODE>loader.getClass().getClassLoader()</CODE>.</P>
<LI><P><STRONG>Create a thread group.</STRONG></P>
<P>The new thread group will be used exclusively by the new process. When all non-daemon threads in the thread group have died, the process has died.</P>
<LI><P><STRONG>Create a class.</STRONG></P>
<P>The class name from step 1 is used to create a new class with the new class loader and, possibly, a new classpath. This is the first opportunity to determine if the class is an instance of <CODE>java.lang.Runnable</CODE>. If it is not run-able, it cannot be used as the entry point of a process.</P>
<LI><P><STRONG>Create an instance.</STRONG></P>
<P>Create a new instance of the class.</P>
<LI><P><STRONG>Create and start a thread</STRONG></P>
<P>Use the new object to start a thread. If an object is an instance of <CODE>java.lang.Thread</CODE>, start it. Otherwise, pass the runnable object to a new instance of <CODE>java.lang.Thread</CODE>.</P>
</UL>
<H4>Special classes</H4>
<P>There are special-case classes in <CODE>java.lang</CODE>. For example, a custom class loader must create a new class for <CODE>java.lang.Runtime</CODE> and <CODE>java.lang.System</CODE> because of their well-known static fields.</P>
<P><EM>How are special-case classes handled?</EM></P>
<P>A special-case class is process-wide, not system-wide. The primordial class loader returns system-wide classes. When asked, the <CODE>java.lang.ClassLoader</CODE> class must return a process-wide class for <CODE>java.lang.Runtime</CODE> and <CODE>java.lang.System</CODE>. A primordial class loader can determine the class that asks for a process-wide class by looking into the thread/threadgroup for the nearest custom class loader.</P>
<H4>Calling <CODE>exit()</CODE></H4>
<P>With a custom class loader, there is more than one instance of <CODE>java.lang.Runtime()</CODE> within a virtual machine. There is one instance for each process. Any object within a process can call <CODE>Runtime.getRuntime().exit()</CODE> to shutdown its own process. All threads belonging to the process' thread group are stopped. A process is dead and only needs to be garbage-collected.</P>
<P>The system process might be the only process that can safely shutdown all of the threads in a process' thread group.</P>
<H4>Modified virtual machine</H4>
<P>Using an off-the-shelf virtual machine as a starting point, there are only a few things that must be re-implemented to create a multiple process virtual machine. First, the primordial class loader should intern all bytecode. It is such a waste to keep more than one copy of a read-only class file in <a href="/view.php?topic=RAM&web=Imported&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">RAM</a> <wikitopic RAM /wikitopic>(or virtual RAM).</P>
<P>Second, <CODE>java.lang.ClassLoader</CODE> must return a process-wide instance of <CODE>java.lang.Runtime</CODE> and <CODE>java.lang.System</CODE>. A custom class loader must be attached to both these classes.</P>
<P>Each process might get a process-wide instance of <CODE>java.awt.Toolkit</CODE>, <CODE>java.lang.SecurityManager</CODE>, and <CODE>java.net.URL</CODE>. These factories and others might have private static fields that need to be process-wide, not system-wide.</P>
<P>Third, <CODE>java.lang.Runtime</CODE> must re-implement its <CODE>exec()</CODE> method. Any process can create a new child process through this method. An instance of <CODE>Process</CODE> represents a new process. It provides access to the child process' return code, standard in, standard error and standard out.</P>
<P>Fourth, garbage collection should be process-wide, not system-wide. Each process should have its own low-priority garbage collection thread.</P>
<P>Fifth, a virtual machine must learn to schedule thread groups based on the general priority of a process. A high priority thread in a low priority process should get a very small timeslice from the processor.</P>
<P>As a shared library, it should enable a "native kernel" process to create multiple instances of a virtual machine.</P>
<H4>Milestone</H4>
<P>It is possible to load only one virtual machine and invoke the Java compiler many times. The Java compiler is a well-known application. It shuts down an off-the-shelf virtual machine with System.exit(). It should not shut down a multiple-process virtual machine. As proof that a virtual machine can manage many processes, a demo program should be written. A successful run of this demo program would be a major milestone.</P>
<H4>Summary</H4>
<P>Context determines what is and what is not a process. Any class that implements the <CODE>Runnable</CODE> interface could become a process in a process context.</P>
<P>Each class loader creates exactly one instance of a "static" field. By building a process context from a custom class loader and re-implementing <CODE>ClassLoader.findSystemClass()</CODE>, the <CODE>exit()</CODE> method will close a process if the process' security manager allows it.</P>
<P>When "native" executable is a class file, a "native" process is a runnable object. Both of these example methods creates a pure-bytecode process:</P>
<PRE>
  public void example_1() {
	 String cmd = "org.jos.demo.DemoProgram";
	 Process p = Runtime.getRuntime().exec( cmd );
	 p.wait();
  }

  public void example_2() {
	 URI uri = new URI( "run:os:org.jos.demo.DemoProgram" );
	 Program p = (Program) uri.getObject();
	 p.run();
  }
</PRE><BR><BR></P><!--

<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="737b9c">
<TR><TD ALIGN="CENTER">
<a href="/user.php?op=login&redirect=%2Fview%2F%2FProcessAndProcessContext&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">login</a> or <a href="/user.php?op=newacct&redirect=%2Fview%2F%2FProcessAndProcessContext&PHPSESSID=30c4f1a625635a7e7b9830ba5b50c812">new&nbsp;user</a><TR><TD>
</TABLE>

!-->
<!-- end BODY page !-->

<HR>

<DIV ALIGN="CENTER">
<TABLE BORDER="0" CELLPADDING="3" CELLSPACING="0" WIDTH="100%">
<TR>
	<TD ALIGN="CENTER" COLSPAN="2">
		Content of these pages are owned and copyrighted by the poster.
	</TD>
</TR>
<TR>
	<TD ALIGN="RIGHT" WIDTH="50%">
		Hosted by:
	</TD>
	<TD ALIGN="LEFT">
		<A HREF="http://sourceforge.net/"><IMG 
			SRC="http://sourceforge.net/sflogo.php?group_id=2376&type=1"
			BORDER=0 HSPACE=0 VSPACE=0></A>
	</TD>
</TR>
</TABLE>
</DIV>
</BODY>
</HTML>
